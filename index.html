<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Signal Plan Checker 1.1.5-alpha</title>
<style>
:root{--bg:#ffffff;--card:#f8f9fb;--line:#e8e8e8;--ink:#222;--muted:#666;--accent:#0a66ff}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;height:100%}
header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fafafa}
h1{font-size:18px;margin:0} small.muted{color:var(--muted)}
main{height:calc(100vh - 60px);display:grid;grid-template-rows:auto 1fr;gap:10px;padding:10px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px}
.tabs{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.tab{padding:8px 10px;border:1px solid var(--line);border-bottom:none;border-radius:8px 8px 0 0;background:#f1f3f6;cursor:pointer}
.tab.active{background:#fff}
.tabpanel{display:none;border:1px solid var(--line);border-radius:0 10px 10px 10px;padding:10px;background:#fff;max-height:40vh;overflow:auto}
.tabpanel.active{display:block}
.grid{border-collapse:collapse;width:100%} .grid th,.grid td{border:1px solid #eee;padding:6px 8px;font-size:12px;text-align:center} .grid th{background:#f7f7f7}
button{padding:8px 10px;border:1px solid #d0d0d0;border-radius:8px;background:#f7f7f7;cursor:pointer;transition:box-shadow .15s,border-color .15s}
button.dirty{border-color:var(--accent); box-shadow: 0 0 0 3px rgba(10,102,255,.15)}
label{display:flex;flex-direction:column;font-size:12px;gap:4px}
input[type=number], select{padding:6px 8px;border:1px solid #d6d6d6;border-radius:6px;min-width:70px}
.badge{padding:2px 6px;border-radius:6px;background:#eef1ff;border:1px solid #dbe1ff;font-size:12px}
#plotPanel{display:grid;grid-template-rows:auto 1fr;gap:8px;height:100%}
#plotToolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
#hiddenWrap{border:1px dashed #bbb;border-radius:8px;background:#fff;overflow:auto;position:relative}
#hiddenCanvas{display:block;image-rendering:crisp-edges}
#debugDock{position:fixed;left:10px;right:10px;bottom:10px;max-height:38vh;overflow:auto;background:#0d1117;color:#c9d1d9;
border:1px solid #30363d;border-radius:10px;padding:8px;font-family:ui-monospace,Consolas,Monaco,monospace;z-index:9999}
.logline.info{color:#a5d6ff} .logline.warn{color:#ffd27f} .logline.err{color:#ffb4b4}
.infochip{padding:4px 8px;border-radius:999px;border:1px solid #e0e0e0;background:#fff;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Signal Plan Checker <small class="muted">1.1.5-alpha</small></h1>
  <div class="row"><span class="badge">UTC plan editor</span><span class="badge">Hidden canvas zoom+scroll</span><span class="badge">Wrapped segment ends</span></div>
</header>

<main>
  <section class="card">
    <div class="row">
      <span class="badge">Init auto-loaded</span>
      <label>Main cycle (s)<input id="mainCycle" type="number" min="1" max="240" value="60"/></label>
      <label>Junctions<input id="jCount" type="number" min="2" max="5" value="3"/></label>
      <label>View cycles
        <select id="viewCycles">
          <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
        </select>
      </label>
      <button id="validateBtn">Validate</button>
      <button id="plotBtn">Plot</button>
      <span id="statusChip" class="infochip">Waiting for Validate…</span>
    </div>
    <div class="tabs" id="jtabs"></div>
    <div id="tabpanels"></div>
  </section>

  <section id="plotPanel" class="card">
    <div id="plotToolbar">
      <strong>Hidden Extended Canvas (dev)</strong>
      <label>Zoom (px/s)<input type="range" id="zoom" min="1" max="12" step="1" value="4"/></label>
      <button id="fitBtn">Fit</button>
      <span id="info" class="badge">—</span>
    </div>
    <div id="hiddenWrap">
      <canvas id="hiddenCanvas"></canvas>
    </div>
  </section>
</main>

<div id="debugDock" style="display:none">
  <div class="row">
    <button id="dbgClear">Clear</button>
    <span>Debug log</span>
  </div>
  <div id="log"></div>
</div>

<script>
const App = { initCfg:null, state:{ validOk:false, readyToPlot:false, pxPerSec:4 } };

function setDirty(){
  const v=document.getElementById('validateBtn');
  const p=document.getElementById('plotBtn');
  if(v) v.classList.add('dirty');
  if(p) p.classList.add('dirty');
  App.state.validOk=false;
  App.state.readyToPlot=false;
  const chip=document.getElementById('statusChip');
  if(chip) chip.textContent='Changes detected — Validate required';
}

function log(msg, level){
  try{
    const box=document.getElementById('log'); if(!box) return;
    const d=document.createElement('div'); d.className='logline '+(level||'info'); d.textContent='['+new Date().toLocaleTimeString()+'] '+msg;
    box.appendChild(d); box.scrollTop=box.scrollHeight;
  }catch(e){}
}
window.addEventListener('error', e=>log('ERROR: '+(e.message||e.error),'err'));
window.addEventListener('unhandledrejection', e=>log('PROMISE: '+(e.reason&&e.reason.message?e.reason.message:e.reason),'err'));

async function loadBundledInit(){
  try{
    const res = await fetch('init.config.json',{cache:'no-store'});
    if(!res.ok) throw new Error('init.config.json not found');
    return await res.json();
  }catch(e){
    return {"appName": "Signal Plan Checker", "ui": {"debug": {"enabled": true, "dock": {"showOnLoad": true}, "logLevel": "info", "validationOnActions": false, "perfMarkers": true}}, "mainCycleTime": {"default": 60, "min": 1, "max": 240, "mustBeEvenWhenAnyDouble": true}, "junctionCount": {"default": 3, "min": 2, "max": 5}, "doubleCycle": {"allowed": true, "requireAtLeastOneMainCycle": true}, "stageCount": {"default": 2, "min": 2}, "stage": {"minGreen": {"default": 7, "min": 1}}, "intergreen": {"diagonalLockedValue": -1, "allowNotPermittedValue": -1, "defaults": {"offDiagonal": 5}, "domain": {"min": 0, "max": 60}}, "journeyTime": {"default": 20, "min": 0, "max": 60}, "utcPlan": {"requireAtLeastOneChange": true, "markRequestsBlue": true, "warnOnDelay": true, "alertOnMissedChange": true, "defaults": [{"to": "S1", "at": 10}, {"to": "S2", "at": 50}]}, "plot": {"hiddenWindowMultiplier": 5, "viewCycles": {"options": [1, 2, 3], "default": 2}, "grid10s": true, "ticks1s": true, "ticks5s": true, "rowHeight": 48, "rowGap": 18, "leftMargin": 120, "topMargin": 24, "pxPerSec": 4}, "overlays": {"adjacentOnly": true, "defaultOpacity": 0.8, "shadeAlpha": 0.15, "repeatByCycle": true, "allowCustomIntervals": true}, "packaging": {"includeDocs": true}};
  }
}

function mkDefaultUTCPlan(cfg){
  return (cfg.utcPlan && Array.isArray(cfg.utcPlan.defaults)) ? JSON.parse(JSON.stringify(cfg.utcPlan.defaults)) : [{to:'S1',at:10},{to:'S2',at:50}];
}

function mkJunction(id, cfg){
  const nStages = Math.max(cfg.stageCount.min, cfg.stageCount.default);
  const stages = []; const minG = cfg.stage.minGreen.default;
  for(let i=0;i<nStages;i++){ stages.push({ label: 'S'+(i+1), minGreenSec: minG }); }
  const N = nStages; const ig = [];
  for(let r=0;r<N;r++){ const row=[]; for(let c=0;c<N;c++){ row.push(r===c ? cfg.intergreen.diagonalLockedValue : cfg.intergreen.defaults.offDiagonal); } ig.push(row); }
  return { id, name:'Junction '+id, doubleCycle:false, utcPlan: mkDefaultUTCPlan(cfg), stages, intergreen: ig, travelPrev: cfg.journeyTime.default, travelNext: cfg.journeyTime.default };
}

function buildState(cfg){
  const count = Math.max(cfg.junctionCount.min, Math.min(cfg.junctionCount.max, cfg.junctionCount.default));
  const ids = ['A','B','C','D','E'].slice(0,count);
  const juncs = ids.map(id=>mkJunction(id, cfg));
  return { ...App.state, mainCycle: Math.max(cfg.mainCycleTime.min, Math.min(cfg.mainCycleTime.max, cfg.mainCycleTime.default)), viewCycles: (cfg.plot.viewCycles && cfg.plot.viewCycles.default)||2, junctions: juncs, pxPerSec: cfg.plot.pxPerSec||4 };
}

function effectiveCycle(j){ return j.doubleCycle ? (App.state.mainCycle/2) : App.state.mainCycle; }
function stageIndex(j, label){ const idx = j.stages.findIndex(s=>s.label===label); return (idx>=0? idx : 0); }
function clampInt(v, lo, hi){ v=parseInt(v||0,10); if(isNaN(v)) v=0; return Math.max(lo, Math.min(hi, v)); }

function validateJunction(j){
  const errs=[];
  j.stages.forEach((s)=>{
    if(!(Number.isInteger(s.minGreenSec) || typeof s.minGreenSec==='number')) errs.push(`${j.name}: Stage ${s.label} minGreen not a number`);
    if(s.minGreenSec < App.initCfg.stage.minGreen.min) errs.push(`${j.name}: Stage ${s.label} minGreen < ${App.initCfg.stage.minGreen.min}`);
  });
  const Cj = effectiveCycle(j);
  if((j.utcPlan||[]).length===0) errs.push(`${j.name}: UTC plan empty`);
  (j.utcPlan||[]).forEach((p,i)=>{
    if(p.at>=Cj) errs.push(`${j.name}: Plan row #${i+1} at=${p.at} ≥ cycle (${Cj})`);
    if(!j.stages.find(s=>s.label===p.to)) errs.push(`${j.name}: Plan row #${i+1} stage '${p.to}' not found`);
  });
  if((j.utcPlan||[]).length>0){
    const sorted = j.utcPlan.slice().sort((a,b)=>a.at-b.at);
    const idxPlan = sorted.map(p=>({toIdx: stageIndex(j,p.to), at:p.at}));
    for(let i=0;i<idxPlan.length;i++){
      const cur = idxPlan[i];
      const nxt = idxPlan[(i+1)%idxPlan.length];
      const ig = j.intergreen[cur.toIdx][nxt.toIdx];
      if(ig === -1){
        const curName = j.stages[cur.toIdx] ? j.stages[cur.toIdx].label : ('S'+(cur.toIdx+1));
        const nxtName = j.stages[nxt.toIdx] ? j.stages[nxt.toIdx].label : ('S'+(nxt.toIdx+1));
        errs.push(`${j.name}: Stage move not permitted ${curName} → ${nxtName}`);
      }
    }
  }
  const N=j.stages.length;
  for(let r=0;r<N;r++){ for(let c=0;c<N;c++){
    const v=j.intergreen[r][c];
    if(r===c && v!==App.initCfg.intergreen.diagonalLockedValue) errs.push(`${j.name}: IG ${j.stages[r].label}→${j.stages[c].label} diagonal must be ${App.initCfg.intergreen.diagonalLockedValue}`);
    if(r!==c){
      if(!Number.isInteger(v)) errs.push(`${j.name}: IG ${j.stages[r].label}→${j.stages[c].label} must be integer or -1`);
      if(v<-1) errs.push(`${j.name}: IG ${j.stages[r].label}→${j.stages[c].label} < -1 invalid`);
      if(v>App.initCfg.intergreen.domain.max) errs.push(`${j.name}: IG ${j.stages[r].label}→${j.stages[c].label} > max ${App.initCfg.intergreen.domain.max}`);
    }
  }}
  if(j.travelPrev<App.initCfg.journeyTime.min || j.travelPrev>App.initCfg.journeyTime.max) errs.push(`${j.name}: Travel ↑ out of range (0..${App.initCfg.journeyTime.max})`);
  if(j.travelNext<App.initCfg.journeyTime.min || j.travelNext>App.initCfg.journeyTime.max) errs.push(`${j.name}: Travel ↓ out of range (0..${App.initCfg.journeyTime.max})`);
  return errs;
}

function runValidation(){
  const errs=[];
  const anyDouble = App.state.junctions.some(j=>j.doubleCycle);
  if(anyDouble && (App.state.mainCycle % 2 !== 0)) errs.push(`Main cycle must be even when any junction is double-cycling.`);
  const anyMain = App.state.junctions.some(j=>!j.doubleCycle);
  if(!anyMain) errs.push(`At least one junction must run the main cycle (not double).`);
  App.state.junctions.forEach(j=>errs.push(...validateJunction(j)));
  const ok = errs.length===0;
  if(ok){
    App.state.validOk = true;  // Set validation flag when no errors
  }
  return ok;
}
</script>
</body>
</html>
