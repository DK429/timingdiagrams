<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Signal Plan Checker v1.0.24.4</title>
<style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#1b1b1b}
header{padding:16px 20px;border-bottom:1px solid #eee;background:#fafafa}
h1{margin:0 0 4px 0;font-size:20px}
.badge{display:inline-block;background:#111;color:#fff;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
main{padding:16px}
.panel{margin-bottom:20px;border:1px solid #e6e6e6;border-radius:8px;padding:12px;background:white}
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.spacer{flex:1}
button{padding:8px 10px;border-radius:6px;border:1px solid #cfcfcf;background:#f6f6f6;cursor:pointer}
button.small{padding:6px 8px;font-size:12px}
button.secondary{background:#eef3ff;border-color:#c2d4ff}
.tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #ddd;border-bottom:none;border-radius:6px 6px 0 0;background:#f2f2f2}
.tab.active{background:white;border-bottom:1px solid white}
.tabPanel{display:none}
.tabPanel.active{display:block}
.dataLayout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.junctionCard{border:1px solid #ececec;border-radius:8px;padding:8px;margin-bottom:10px}
.junctionRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
.stagesTable{width:100%;border-collapse:collapse;margin-top:6px}
.stagesTable th, .stagesTable td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
.stageBtns{display:flex;gap:6px}
.readout{margin-top:8px;padding:8px;border:1px dashed #ddd;border-radius:6px;background:#fcfcfc;font-family:ui-monospace,Consolas,Monaco,monospace}
.diagramHeader{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
svg{border:1px solid #e6e6e6;border-radius:6px;background:#fff}
.legend{margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;font-size:13px}
.legend .item{display:flex;align-items:center;gap:6px}
.legend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #999}
.gridLine{stroke:#e9e9e9;stroke-width:1}
.axisLabel{font-size:10px;fill:#777}
.rowLabel{font-size:12px;fill:#333}
.stageRect{opacity:.95}
.intergreenRect{fill:#c7c7c7;opacity:.5}
.tick5{stroke:#000;stroke-width:1}
.tick1{stroke:#000;stroke-width:1;opacity:.85}
.stageLabel{font-size:11px;fill:#fff;dominant-baseline:middle;text-anchor:middle}
.stageTimeLabel{font-size:10px; fill:#444; text-anchor:middle}
.offsetLabel{font-size:11px; fill:#666}
.coordLine{stroke:#111;stroke-width:2; marker-end:url(#arrow)}
.coordLine.back{stroke-dasharray:3 3}
.arrivalHighlight{fill:#ffd54d;opacity:.25}
.channelGrid{stroke:#e9e9e9;stroke-width:1}
.channelTT{font-size:11px; fill:#333}
.overlayBand{opacity:0.18}
.overlayShade{opacity:0.18}
.debugLog{max-height:220px; overflow:auto; background:#0d1117; color:#c9d1d9; font-family:ui-monospace,Consolas,Monaco,monospace; font-size:12px; padding:8px; border-radius:6px; border:1px solid #30363d}
.debugLog .err{color:#ffb4b4}.debugLog .warn{color:#ffd27f}.debugLog .info{color:#a5d6ff}
#bootBanner{position:fixed;inset:auto 12px 12px auto;background:#0d1117;color:#ffd27f;padding:8px 10px;border-radius:8px;
font-family:ui-monospace,Consolas,Monaco,monospace;font-size:12px;z-index:99999}
summary{cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Signal Plan Checker <span class="badge">v1.0.24.4</span></h1>
  <div>Fix: overlay add + minimal overlay rendering; stronger clipboard logging & fallbacks.</div>
</header>

<main>
  <nav class="tabs">
    <button type="button" class="tab active" data-tab="dataTab">Data</button>
    <button type="button" class="tab" data-tab="plotTab">Plot</button>
  </nav>

  <section id="dataTab" class="tabPanel active panel">
    <div class="dataLayout">
      <div>
        <div class="toolbar">
          <strong>Junctions</strong>
          <div class="spacer"></div>
          <button type="button" id="addJunctionBtn" class="small">+ Add junction</button>
        </div>
        <div id="junctionList"></div>
      </div>
      <div>
        <div class="toolbar">
          <strong>Journey times (seconds)</strong>
          <div class="spacer"></div>
          <button type="button" id="rebuildMatrix" class="small">Rebuild matrix</button>
        </div>
        <div id="journeyMatrix"></div>
      </div>
    </div>
    <div class="buttons">
      <button type="button" id="resetDefaultsBtn" class="secondary">Reset to defaults</button>
      <button type="button" id="forceInitBtn" class="small">Force init</button>
      <button type="button" id="validateBtn">Validate</button>
      <span class="version">v1.0.24.4</span>
    </div>
    <div id="dataValidation" class="readout" style="margin-left:0;margin-top:10px"></div>

    <div class="buttons">
      <button type="button" id="exportBtn">Export JSON</button>
      <label class="importLabel">Import JSON <input id="importInput" type="file" accept="application/json"/></label>
      <button type="button" id="saveTdBtn">Save TD</button>
      <label class="importLabel">Load TD <input id="loadTdInput" type="file" accept=".td,application/json"/></label>
    </div>
  </section>

  <section id="plotTab" class="tabPanel panel">
    <div class="diagramHeader">
      <div class="toolbar" style="width:100%">
        <label>Diagram horizon (s)
          <input id="horizon" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" value=""/>
        </label>
        <button type="button" id="plotBtn">Plot diagram</button>
        <label><input type="checkbox" id="showMainGrid" checked> Show main grid</label>
        <label>Overruns
          <select id="overrunMode">
            <option value="skip">Skip</option>
            <option value="clip" selected>Clip</option>
          </select>
        </label>
        <div class="spacer"></div>
        <button type="button" id="copyPlotBtn">Copy plot to clipboard</button>
      </div>

      <details id="overlayPanel" open>
        <summary>Overlays</summary>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <label>Origin <select id="ovOrigin"></select></label>
          <label>Stage <select id="ovStage"></select></label>
          <label>Mode
            <select id="ovMode">
              <option value="interval" selected>Interval (whole stage)</option>
              <option value="point">Point (stage start)</option>
              <option value="pointEnd">Point (stage end)</option>
            </select>
          </label>
          <label>Destination <select id="ovDest"></select></label>
          <label>Opacity <input id="ovOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="ovColor" type="color" value="#ff5722"/></label>
          <label><input id="ovRepeat" type="checkbox" checked> Repeat each cycle (stage)</label>
          <button type="button" id="addOverlayBtn">Add overlay</button>
        </div>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-top:6px;border-top:1px dashed #ddd;padding-top:6px">
          <strong>Custom overlay:</strong>
          <label>Origin <select id="coOrigin"></select></label>
          <label>Start (s) <input id="coStart" type="text" inputmode="numeric" pattern="[0-9]*" value="0"/></label>
          <label>End (s) <input id="coEnd" type="text" inputmode="numeric" pattern="[0-9]*" value="20"/></label>
          <label>Destination <select id="coDest"></select></label>
          <label>Opacity <input id="coOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="coColor" type="color" value="#9c27b0"/></label>
          <label><input id="coRepeat" type="checkbox" checked> Repeat each cycle (aligned to origin)</label>
          <button type="button" id="addCustomOverlayBtn">Add custom</button>
        </div>
      </details>
    </div>

    <div id="plotHolder">
      <svg id="diagram" width="100%" height="900" role="img" aria-label="Time–stage diagram"></svg>
    </div>

    <div id="legend" class="legend"></div>
    <div id="readout" class="readout"></div>
  </section>

  <section id="debugSection" class="panel" style="margin-top:10px">
    <details id="debugDetails" open>
      <summary>Debug Log</summary>
      <div id="debugLog" class="debugLog"></div>
      <div style="margin-top:6px; display:flex; gap:8px; align-items:center">
        <button type="button" id="clearDebugBtn" class="small">Clear log</button>
        <span class="axisLabel">Init/Render steps appear here.</span>
      </div>
    </details>
  </section>
</main>

<div id="bootBanner">script: loading…</div>

<script>
// ===== Utilities =====
function $(id){ return document.getElementById(id); }
function elNS(tag){ return document.createElementNS('http://www.w3.org/2008/svg', tag); } // fixed svg ns
function setAttrs(ele, attrs){ for(var k in attrs) ele.setAttribute(k, attrs[k]); return ele; }
function num(v){ var s=String(v||'').replace(/[^0-9\-]/g, ''); var n=Number(s); return isFinite(n)?n:0; }
function log(msg, level){ try{ var box=$('debugLog'); if(!box) return; var div=document.createElement('div'); div.className=level||'info'; var t=(new Date()).toLocaleTimeString(); div.textContent='['+t+'] '+msg; box.appendChild(div); box.scrollTop=box.scrollHeight; }catch(e){} }

(function(){ var b=$('bootBanner'); if(b){ b.textContent='script: running (pre-DOM)'; } })();
window.addEventListener('error', function(e){ log('ERROR: '+(e.message||e.error), 'err'); });
window.addEventListener('unhandledrejection', function(e){ log('PROMISE: '+(e.reason&&e.reason.message?e.reason.message:e.reason), 'err'); });

// ===== State =====
var state = { junctions: [], journeys: {}, horizonSec: 0, horizonIsDefault: true, overlays: [],
  rowOrder: ['A','B','C','D'], showMainGrid: true, overrunMode: 'clip' };

// ===== Tabs =====
function initTabs(){
  var tabs=document.querySelectorAll('.tab');
  for(var i=0;i<tabs.length;i++){
    (function(btn){
      btn.addEventListener('click', function(){
        var all=document.querySelectorAll('.tab'); for(var j=0;j<all.length;j++) all[j].classList.remove('active');
        var panels=document.querySelectorAll('.tabPanel'); for(var j=0;j<panels.length;j++) panels[j].classList.remove('active');
        btn.classList.add('active');
        var id=btn.getAttribute('data-tab'); var panel=$(id);
        if(panel) panel.classList.add('active');
        if(id==='plotTab') render();
      });
    })(tabs[i]);
  }
}

// ===== Defaults & helpers =====
function buildDefaults(){
  state.junctions = [];
  function makeJ(id){
    return { id:id, name:'Junction '+id, cycleTimeSec:60, startTimeSec:0,
      stages:[{label:id+'1',durationSec:15},{label:id+'2',durationSec:15},{label:id+'3',durationSec:15}],
      intergreens:[{durationSec:5},{durationSec:5},{durationSec:5}] };
  }
  state.junctions.push(makeJ('A'), makeJ('B'), makeJ('C'), makeJ('D'));
  state.journeys = {'A->B':22,'B->A':24,'B->C':26,'C->B':23,'C->D':28,'D->C':29};
  state.overlays = []; // clear overlays on reset
  setDefaultHorizon();
  log('Default data created','info');
}
function getJ(id){ for(var i=0;i<state.junctions.length;i++){ if(state.junctions[i].id===id) return state.junctions[i]; } return null; }
function idxOf(id){ var o=presentRowOrder(); for(var i=0;i<o.length;i++) if(o[i]===id) return i; return -1; }
function alignIntergreens(j){ var n=j.stages.length; while(j.intergreens.length<n) j.intergreens.push({durationSec:0}); if(j.intergreens.length>n) j.intergreens=j.intergreens.slice(0,n); }
function updateTotalsForJunction(id){
  var j=getJ(id); if(!j) return;
  var st=0,ig=0; for(var i=0;i<j.stages.length;i++){ st+=num(j.stages[i].durationSec); ig+=num(j.intergreens[i].durationSec||0); }
  var el=$('tot_'+id); if(el){ el.textContent='Total used: '+(st+ig)+'s (stages '+st+'s + intergreens '+ig+'s) / cycle '+j.cycleTimeSec+'s'; }
}
function presentRowOrder(){ var out=[]; for(var i=0;i<state.rowOrder.length;i++){ if(getJ(state.rowOrder[i])) out.push(state.rowOrder[i]); } return out; }
function maxCycle(){ var m=0; for(var i=0;i<state.junctions.length;i++) m=Math.max(m, state.junctions[i].cycleTimeSec||0); return m; }
function setDefaultHorizon(){ var def=Math.max(60, maxCycle()+20); var h=$('horizon'); if(!h) return; if(state.horizonIsDefault || !num(h.value)){ h.value=String(def); state.horizonSec=def; state.horizonIsDefault=true; } }
function stageFill(idx){ var shades=['#1b5e20','#2e7d32','#388e3c','#43a047','#4caf50','#66bb6a','#7cb342','#8bc34a']; return shades[idx%shades.length]; }
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

// path: list of adjacent pairs, and total journey time
function channelPath(a,b){
  var o=presentRowOrder(); var ai=o.indexOf(a), bi=o.indexOf(b);
  if(ai===-1||bi===-1) return [];
  var path=[], step=ai<bi?1:-1;
  for(var i=ai;i!==bi;i+=step){ var id1=o[i], id2=o[i+step]; var pair=id1+'->'+id2; path.push(pair); }
  return path;
}
function pathTravelSeconds(a,b){
  var p=channelPath(a,b); var sum=0;
  for(var i=0;i<p.length;i++){ if(state.journeys[p[i]]!=null) sum+=num(state.journeys[p[i]]); }
  return sum;
}

// ===== Data UI =====
function renderJunctionList(){
  var container=$('junctionList'); if(!container){ log('junctionList missing','err'); return; }
  container.innerHTML='';
  for(var ji=0; ji<state.junctions.length; ji++){
    var j=state.junctions[ji]; alignIntergreens(j);
    var card=document.createElement('div'); card.className='junctionCard';
    card.innerHTML=''
      +'<div class="junctionRow">'
      +'<label>Id <input value="'+j.id+'" disabled></label>'
      +'<label>Name <input data-bind="name" data-id="'+j.id+'" value="'+j.name+'"></label>'
      +'<label>Start offset (s) <input data-bind="start" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.startTimeSec+'"></label>'
      +'</div>'
      +'<div class="junctionRow">'
      +'<label>Cycle time (s) <input data-bind="cycle" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.cycleTimeSec+'"></label>'
      +'</div>'
      +'<h4>Stages</h4>'
      +'<table class="stagesTable"><thead><tr><th>Label</th><th>Duration (s)</th><th>Intergreen after (s)</th><th></th></tr></thead>'
      +'<tbody id="stBody_'+j.id+'"></tbody></table>'
      +'<div class="stageBtns"><button type="button" class="small" data-add-stage="'+j.id+'">+ Add stage</button>'
      +(state.junctions.length>2? '<button type="button" class="small" data-remove-j="'+j.id+'">Remove junction</button>':'')
      +'</div>'
      +'<div class="totalsRow" id="tot_'+j.id+'" style="margin-top:6px;font-size:12px;color:#555"></div>';
    container.appendChild(card);
    var tbody=card.querySelector('#stBody_'+j.id+'');
    for(var i=0;i<j.stages.length;i++){
      var s=j.stages[i], ig=j.intergreens[i].durationSec||0;
      var tr=document.createElement('tr');
      tr.innerHTML='<td><input data-st="label" data-id="'+j.id+'" data-idx="'+i+'" value="'+s.label+'"></td>'
        +'<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="dur" data-id="'+j.id+'" data-idx="'+i+'" value="'+s.durationSec+'"></td>'
        +'<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="ig" data-id="'+j.id+'" data-idx="'+i+'" value="'+ig+'"></td>'
        +'<td><button type="button" class="small" data-del-stage="'+j.id+'" data-idx="'+i+'">✕</button></td>';
      tbody.appendChild(tr);
    }
  }
  var binds=container.querySelectorAll('input[data-bind]');
  for(var b=0;b<binds.length;b++){ (function(inp){
    function commit(){
      var j=getJ(inp.getAttribute('data-id')); if(!j) return;
      var bind=inp.getAttribute('data-bind');
      if(bind==='name') j.name=inp.value;
      if(bind==='start') j.startTimeSec=num(inp.value);
      if(bind==='cycle'){ j.cycleTimeSec=num(inp.value); if(state.horizonIsDefault){ setDefaultHorizon(); } }
      rebuildJourneyMatrix(); refreshOverlayPickers(); render(); updateDataValidation(); updateTotalsForJunction(j.id);
    }
    inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
  })(binds[b]); }
  var stInputs=container.querySelectorAll('input[data-st]');
  for(var si=0; si<stInputs.length; si++){ (function(inp){
    function commit(){
      var j=getJ(inp.getAttribute('data-id')); var idx=Number(inp.getAttribute('data-idx'));
      if(inp.getAttribute('data-st')==='label') j.stages[idx].label = inp.value;
      if(inp.getAttribute('data-st')==='dur') j.stages[idx].durationSec = num(inp.value);
      if(inp.getAttribute('data-st')==='ig') j.intergreens[idx].durationSec = num(inp.value);
      refreshOverlayPickers(); render(); updateDataValidation(); updateTotalsForJunction(j.id);
    }
    inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
  })(stInputs[si]); }
  var addBtns=container.querySelectorAll('[data-add-stage]');
  for(var ai=0; ai<addBtns.length; ai++){ addBtns[ai].addEventListener('click', function(ev){ var id=ev.currentTarget.getAttribute('data-add-stage'); var j=getJ(id); var n=j.stages.length+1; j.stages.push({label:id+n,durationSec:10}); j.intergreens.push({durationSec:2}); renderJunctionList(); refreshOverlayPickers(); render(); updateDataValidation(); }); }
  var delBtns=container.querySelectorAll('[data-del-stage]');
  for(var di=0; di<delBtns.length; di++){ delBtns[di].addEventListener('click', function(ev){ var id=ev.currentTarget.getAttribute('data-del-stage'); var idx=Number(ev.currentTarget.getAttribute('data-idx')); var j=getJ(id); j.stages.splice(idx,1); j.intergreens.splice(idx,1); renderJunctionList(); refreshOverlayPickers(); render(); updateDataValidation(); }); }
  var remBtns=container.querySelectorAll('[data-remove-j]');
  for(var ri=0; ri<remBtns.length; ri++){ remBtns[ri].addEventListener('click', function(ev){ var id=ev.currentTarget.getAttribute('data-remove-j'); state.junctions = state.junctions.filter(function(x){return x.id!==id;}); renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); setDefaultHorizon(); render(); updateDataValidation(); }); }
  for(var t=0;t<state.junctions.length;t++) updateTotalsForJunction(state.junctions[t].id);
  refreshOverlayPickers();
  log('Junction list rendered','info');
}

function rebuildJourneyMatrix(){
  var cont=$('journeyMatrix'); if(!cont){ log('journeyMatrix missing','err'); return; }
  cont.innerHTML='';
  var n=state.junctions.length; if(n<2){ cont.textContent='Add at least two junctions.'; return; }
  var table=document.createElement('table'); table.className='stagesTable';
  var thead=document.createElement('thead'); var hrow='<tr><th>From \\\\ To</th>'; for(var i=0;i<n;i++) hrow+='<th>'+state.junctions[i].name+'</th>'; hrow+='</tr>'; thead.innerHTML=hrow; table.appendChild(thead);
  var tbody=document.createElement('tbody');
  for(var r=0;r<n;r++){
    var fromJ=state.junctions[r]; var row='<td><strong>'+fromJ.name+'</strong></td>';
    for(var c=0;c<n;c++){
      var toJ=state.junctions[c];
      if(fromJ.id===toJ.id){ row+='<td style="text-align:center;color:#888">—</td>'; }
      else{ var key=fromJ.id+'->'+toJ.id; var val= state.journeys[key]!=null? state.journeys[key] : 20;
        row+='<td><input data-journey="'+key+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+val+'"></td>'; }
    }
    var tr=document.createElement('tr'); tr.innerHTML=row; tbody.appendChild(tr);
  }
  table.appendChild(tbody); cont.appendChild(table);
  var inps = cont.querySelectorAll('input[data-journey]');
  for(var i=0;i<inps.length;i++){ (function(inp){ function commit(){ state.journeys[inp.getAttribute('data-journey')] = num(inp.value); render(); } inp.addEventListener('blur', commit); inp.addEventListener('change', commit); })(inps[i]); }
  log('Journey matrix rendered','info');
}

// ===== Validation =====
function validate(){
  var errors=[];
  if(state.junctions.length<2) errors.push('Add at least two junctions.');
  for(var i=0;i<state.junctions.length;i++){
    var j=state.junctions[i]; alignIntergreens(j);
    if(j.stages.length===0) errors.push(j.name+': add at least one stage.');
    if(j.intergreens.length!==j.stages.length) errors.push(j.name+': intergreens count must match stages count.');
    if(j.cycleTimeSec<=0) errors.push(j.name+': cycle time must be > 0.');
    var st=0, ig=0; for(var k=0;k<j.stages.length;k++){ st+=num(j.stages[k].durationSec); ig+=num(j.intergreens[k].durationSec||0); }
    if((st+ig)!==j.cycleTimeSec){ errors.push(j.name+': stages + intergreens ('+(st+ig)+'s = '+st+'s + '+ig+'s) must equal cycle ('+j.cycleTimeSec+'s).'); }
  }
  return errors;
}
function updateDataValidation(){ var out=$('dataValidation'); if(!out) return; var errs=validate(); if(errs.length){ out.innerHTML='<div class="bad"><strong>Fix these first:</strong><ul>'+errs.map(function(e){return '<li>'+e+'</li>';}).join('')+'</ul></div>'; } else out.innerHTML='<div class="good">Config looks valid ✔️</div>'; }

// ===== Plot =====
function ensureArrowDefs(s){ if(s.querySelector('defs#arrowDefs')) return; var defs=elNS('defs'); defs.id='arrowDefs'; var m=elNS('marker'); m.setAttribute('id','arrow'); m.setAttribute('viewBox','0 0 10 10'); m.setAttribute('refX','8'); m.setAttribute('refY','5'); m.setAttribute('markerWidth','6'); m.setAttribute('markerHeight','6'); m.setAttribute('orient','auto'); var p=elNS('path'); p.setAttribute('d','M 0 0 L 10 5 L 0 10 z'); p.setAttribute('fill','context-stroke'); m.appendChild(p); defs.appendChild(m); s.appendChild(defs); }

function render(){
  var s=$('diagram'); if(!s){ log('diagram SVG missing','err'); return; }
  s.innerHTML='';
  var H = state.horizonSec = num($('horizon').value) || Math.max(60, maxCycle()+20);
  if(!$('horizon').value) $('horizon').value=String(H);
  var showMainGrid = state.showMainGrid = $('showMainGrid') ? $('showMainGrid').checked : true;
  var width = s.clientWidth || 960; var MARGIN=60; var HEIGHT = 20 + (presentRowOrder().length-1)*(30+120) + 30 + 80; s.setAttribute('height', String(HEIGHT));
  var usableW = (width - MARGIN - 10);
  var xScale = function(t){ return MARGIN + (t/H)*usableW; };
  ensureArrowDefs(s);

  // Global grid
  if(showMainGrid){
    for(var t=0;t<=H;t+=10){
      var ln=elNS('line'); setAttrs(ln,{x1:xScale(t),y1:8,x2:xScale(t),y2:HEIGHT-8,class:'gridLine'}); s.appendChild(ln);
      if(t%30===0){ var tx=elNS('text'); setAttrs(tx,{x:xScale(t)+2,y:12,class:'axisLabel'}); tx.textContent=t+'s'; s.appendChild(tx); }
    }
  } else {
    for(var t2=0;t2<=H;t2+=30){ var tx2=elNS('text'); setAttrs(tx2,{x:xScale(t2)+2,y:12,class:'axisLabel'}); tx2.textContent=t2+'s'; s.appendChild(tx2); }
  }

  var order = presentRowOrder();
  var rowYTops = {}; // cache band tops
  for(var r=0;r<order.length;r++){
    var j=getJ(order[r]); if(!j) continue;
    var yTop=20 + r*(30+120); var yBandTop=yTop+10, yBandBot=yBandTop+30;
    rowYTops[j.id]=yBandTop;
    var lbl=elNS('text'); setAttrs(lbl,{x:10,y:yTop+4,class:'rowLabel'}); lbl.textContent=j.name; s.appendChild(lbl);
    var offlbl=elNS('text'); setAttrs(offlbl,{x:10,y:yTop+16,class:'offsetLabel'}); offlbl.textContent='Offset: '+(j.startTimeSec||0)+'s'; s.appendChild(offlbl);
    // ticks
    for(var t=0;t<=H;t+=1){ var x=xScale(t);
      var l1=elNS('line'); setAttrs(l1,{x1:x,y1:yBandTop-3,x2:x,y2:yBandTop,class:'tick1'}); s.appendChild(l1);
      var l2=elNS('line'); setAttrs(l2,{x1:x,y1:yBandBot,x2:x,y2:yBandBot+3,class:'tick1'}); s.appendChild(l2);
    }
    for(var t5=0;t5<=H;t5+=5){ var x5=xScale(t5);
      var L1=elNS('line'); setAttrs(L1,{x1:x5,y1:yBandTop-6,x2:x5,y2:yBandTop,class:'tick5'}); s.appendChild(L1);
      var L2=elNS('line'); setAttrs(L2,{x1:x5,y1:yBandBot,x2:x5,y2:yBandBot+6,class:'tick5'}); s.appendChild(L2);
    }
    // bands (simple horizon-tiling visual, no wrap splitting)
    var C=j.cycleTimeSec, t0=j.startTimeSec||0, t=0;
    while(t<=H){
      for(var i=0;i<j.stages.length;i++){
        var sDur=j.stages[i].durationSec, ig=j.intergreens[i].durationSec||0;
        var s0=(t + (t0%j.cycleTimeSec + j.cycleTimeSec)%j.cycleTimeSec)%H;
        var s1=(s0 + sDur)%H;
        if(s1 < s0){
          var r1=elNS('rect'); setAttrs(r1,{x:xScale(s0),y:yBandTop,width:xScale(H)-xScale(s0),height:30,class:'stageRect'}); r1.setAttribute('fill', stageFill(i)); s.appendChild(r1);
          var r2=elNS('rect'); setAttrs(r2,{x:xScale(0),y:yBandTop,width:xScale(s1)-xScale(0),height:30,class:'stageRect'}); r2.setAttribute('fill', stageFill(i)); s.appendChild(r2);
        } else {
          var rect=elNS('rect'); setAttrs(rect,{x:xScale(s0),y:yBandTop,width:Math.max(0,xScale(s1)-xScale(s0)),height:30,class:'stageRect'}); rect.setAttribute('fill', stageFill(i)); s.appendChild(rect);
        }
        if((s1 - s0 + H)%H * usableW/H > 24){
          var mid = (s0 + ( (s1>=s0)? (s1-s0)/2 : ((H-s0)+s1)/2 )) % H;
          var tx=elNS('text'); setAttrs(tx,{x:xScale(mid), y:yBandTop+15, class:'stageLabel'}); tx.textContent=j.stages[i].label; s.appendChild(tx);
        }
        // intergreen
        var ig0 = s1, ig1 = (s1 + ig)%H;
        if(ig>0){
          if(ig1 < ig0){
            var igA=elNS('rect'); setAttrs(igA,{x:xScale(ig0),y:yBandTop,width:xScale(H)-xScale(ig0),height:30,class:'intergreenRect'}); s.appendChild(igA);
            var igB=elNS('rect'); setAttrs(igB,{x:xScale(0),y:yBandTop,width:xScale(ig1)-xScale(0),height:30,class:'intergreenRect'}); s.appendChild(igB);
          } else {
            var igR=elNS('rect'); setAttrs(igR,{x:xScale(ig0),y:yBandTop,width:Math.max(0,xScale(ig1)-xScale(ig0)),height:30,class:'intergreenRect'}); s.appendChild(igR);
          }
        }
        t += sDur + ig;
      }
    }
    // cycle markers (at 0..H modulo)
    var C=j.cycleTimeSec;
    if(C>0){
      for(var tt=0; tt<=H; tt+=C){
        var xl=xScale(tt); var ln2=elNS('line'); setAttrs(ln2,{x1:xl,y1:yBandTop-6,x2:xl,y2:yBandTop+30+6,class:'gridLine'});
        ln2.setAttribute('stroke','#e53935'); ln2.setAttribute('stroke-width','2'); s.appendChild(ln2);
      }
      var yBottomLbl=yBandTop+30+16;
      for(var ttt=0; ttt<=H; ttt+=5){
        var tx3=elNS('text'); setAttrs(tx3,{x:xScale(ttt)+2,y:yBottomLbl,class:'axisLabel'}); tx3.textContent=String(ttt%C)+'s'; s.appendChild(tx3);
      }
    }
  }

  // channel grids (0..H)
  if($('showMainGrid') && $('showMainGrid').checked){
    for(var i=0;i<order.length-1;i++){ var chTop=rowYTops[order[i]]+30+10, chBot=rowYTops[order[i+1]]-10; for(var t=0;t<=H;t+=10){ var ln=elNS('line'); setAttrs(ln,{x1:xScale(t),y1:chTop,x2:xScale(t),y2:chBot,class:'channelGrid'}); s.appendChild(ln);} }
  }

  // ===== Overlays (minimal baseline rendering) =====
  function addLine(x0,y0,x1,y1,color,op){ var ln=elNS('line'); setAttrs(ln,{x1:x0,y1:y0,x2:x1,y2:y1,stroke:color,'stroke-width':2,opacity:op||0.9,class:'coordLine'}); s.appendChild(ln); }
  function addRect(x0,y0,w,h,color,op){ var r=elNS('rect'); setAttrs(r,{x:x0,y:y0,width:Math.max(0,w),height:Math.max(0,h),fill:color,opacity:op||0.18,class:'overlayShade'}); s.appendChild(r); }
  function stageOffsets(j){ var arr=[]; var t=0; for(var i=0;i<j.stages.length;i++){ arr.push(t); t+=j.stages[i].durationSec + (j.intergreens[i].durationSec||0); } return arr; }

  for(var oi=0; oi<state.overlays.length; oi++){
    var ov = state.overlays[oi];
    var J0 = getJ(ov.origin), J1 = getJ(ov.dest);
    if(!J0 || !J1) continue;
    var travel = pathTravelSeconds(ov.origin, ov.dest); // total travel seconds across path
    var y0 = rowYTops[J0.id] + 15; var y1 = rowYTops[J1.id] + 15;
    var color = ov.color||'#ff5722'; var op = ov.opacity||0.8;
    // determine event times at origin
    var C = J0.cycleTimeSec;
    var off = (J0.startTimeSec||0);
    var times = []; // list of {tStart,tEnd}
    if(ov.kind==='stage'){
      var idx = ov.stageIndex||0;
      var offs = stageOffsets(J0)[idx]||0;
      var sDur = J0.stages[idx].durationSec||0;
      // cycles to inspect
      var kMin = Math.floor((-off - offs)/C) - 1;
      var kMax = Math.ceil((state.horizonSec - off - offs)/C) + 1;
      for(var k=kMin; k<=kMax; k++){
        var tStart = off + offs + k*C;
        var tEnd = tStart + sDur;
        if(ov.mode==='interval'){
          if(ov.repeat || (tStart<=state.horizonSec && tEnd>=0)){
            times.push({tStart:tStart, tEnd:tEnd});
          }
        } else if(ov.mode==='point'){
          times.push({tStart:tStart, tEnd:tStart});
        } else if(ov.mode==='pointEnd'){
          times.push({tStart:tEnd, tEnd:tEnd});
        }
      }
    } else if(ov.kind==='custom'){
      var cs = num(ov.cStart)||0, ce = num(ov.cEnd)||0;
      var base = off; // align to origin cycle zero
      var kMin = -1, kMax = Math.ceil((state.horizonSec)/C)+1;
      for(var k=kMin; k<=kMax; k++){
        var tStart = base + cs + k*C;
        var tEnd = base + ce + k*C;
        if(ov.repeat || (tStart<=state.horizonSec && tEnd>=0)){
          times.push({tStart:tStart, tEnd:tEnd});
        }
      }
    }

    // draw each occurrence within horizon (clip)
    for(var ti=0; ti<times.length; ti++){
      var e = times[ti];
      var a0 = e.tStart + travel;
      var a1 = e.tEnd + travel;
      // Clip to [0,H]
      if(e.tEnd < 0 || e.tStart > state.horizonSec) continue; // origin outside
      // map to modulo H for x
      var x0 = xScale( ((e.tStart%H)+H)%H );
      var x1 = xScale( ((a0%H)+H)%H );
      var x2 = xScale( ((e.tEnd%H)+H)%H );
      var x3 = xScale( ((a1%H)+H)%H );
      // draw lines (front/back)
      addLine(x0, y0, x1, y1, color, op);
      if(ov.mode==='interval'){
        addLine(x2, y0, x3, y1, color, op*0.85);
        // shade arrival band at destination across the stage duration
        var yTopDest = rowYTops[J1.id];
        var yBotDest = yTopDest + 30;
        // naive: assume no wrap; if wrap, two rects would be needed (baseline keeps simple)
        var xa = Math.min(x1,x3), xb = Math.max(x1,x3);
        addRect(xa, yTopDest, xb-xa, 30, color, 0.18);
      }
    }
  }

  updateDataValidation();
  log('Plot rendered (H='+H+'s)','info');
}

// ===== Overlay pickers & handlers =====
function refreshOverlayPickers(){
  var o=$('ovOrigin'), d=$('ovDest'), s=$('ovStage'), coO=$('coOrigin'), coD=$('coDest');
  function fillSel(sel){
    if(!sel) return;
    var cur=sel.value; sel.innerHTML='';
    for(var i=0;i<state.rowOrder.length;i++){ var id=state.rowOrder[i]; var j=getJ(id); if(j){ var opt=document.createElement('option'); opt.value=id; opt.textContent=j.name; sel.appendChild(opt);} }
    if(cur && getJ(cur)) sel.value=cur;
  }
  fillSel(o); fillSel(d); fillSel(coO); fillSel(coD);
  function fillStages(){
    if(!s) return; s.innerHTML='';
    var originId = o && o.value ? o.value : (presentRowOrder()[0]||null);
    if(originId){ var j=getJ(originId); if(j){ for(var i=0;i<j.stages.length;i++){ var op=document.createElement('option'); op.value=String(i); op.textContent=j.stages[i].label; s.appendChild(op);} } }
  }
  fillStages();
  if(o && !o._hasStageSync){ o.addEventListener('change', fillStages); o._hasStageSync=true; }
}

function addOverlayFromUI(){
  var originSel=$('ovOrigin'), destSel=$('ovDest'), stageSel=$('ovStage'), modeSel=$('ovMode');
  var col=$('ovColor').value, op=parseFloat($('ovOpacity').value||'0.8');
  if(!originSel||!destSel||!stageSel||!modeSel){ log('Overlay form missing controls','err'); return; }
  var origin = originSel.value, dest = destSel.value, idx = parseInt(stageSel.value||'0',10);
  state.overlays.push({ kind:'stage', origin:origin, dest:dest, stageIndex:idx, mode:modeSel.value, color:col, opacity:op, repeat: $('ovRepeat').checked });
  log('Overlay added: '+origin+' '+(getJ(origin).stages[idx].label)+' → '+dest+' ('+modeSel.value+')','info');
  render();
}
function addCustomOverlayFromUI(){
  var originSel=$('coOrigin'), destSel=$('coDest');
  if(!originSel||!destSel){ log('Custom overlay form missing controls','err'); return; }
  var col=$('coColor').value, op=parseFloat($('coOpacity').value||'0.8');
  var cs = num($('coStart').value||0), ce = num($('coEnd').value||0);
  var origin=originSel.value, dest=destSel.value;
  state.overlays.push({ kind:'custom', origin:origin, dest:dest, cStart:cs, cEnd:ce, color:col, opacity:op, repeat: $('coRepeat').checked });
  log('Custom overlay added: '+origin+' ['+cs+','+ce+'] → '+dest,'info');
  render();
}

// ===== Clipboard =====
async function copyPlotToClipboard(){
  log('Copy plot clicked','info');
  var svg = $('diagram'); if(!svg){ log('No diagram SVG','err'); alert('No diagram to copy.'); return; }
  // Try PNG
  try{
    var bbox = svg.getBoundingClientRect();
    var clone = svg.cloneNode(true);
    var width = Math.max(1, Math.floor(bbox.width));
    var height = Math.max(1, Math.floor(bbox.height));
    clone.setAttribute('width', width);
    clone.setAttribute('height', height);
    var ser = new XMLSerializer();
    var svgStr = ser.serializeToString(clone);
    var svgBlob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
    var url = URL.createObjectURL(svgBlob);
    var img = new Image();
    var scale = 2;
    var canvas = document.createElement('canvas');
    canvas.width = width * scale;
    canvas.height = height * scale;
    var ctx = canvas.getContext('2d');
    await new Promise(function(resolve, reject){
      img.onload = function(){ try{ ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0,width,height); resolve(); } catch(e){ reject(e); } finally { URL.revokeObjectURL(url); } };
      img.onerror = function(e){ reject(e); };
      img.src = url;
    });
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
    if(navigator.clipboard && window.ClipboardItem){
      await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
      log('Copied plot as image/png to clipboard','info');
      $('readout').innerHTML = '<div class="good">Plot copied to clipboard as image ✅</div>';
      return;
    }
    throw new Error('Image clipboard not supported');
  } catch(err){
    log('PNG copy failed: '+(err.message||err),'warn');
  }
  // Try SVG directly
  try{
    var ser = new XMLSerializer(); var txt = ser.serializeToString(svg);
    if(navigator.clipboard && window.ClipboardItem){
      var blob = new Blob([txt], {type:'image/svg+xml'});
      await navigator.clipboard.write([new ClipboardItem({'image/svg+xml': blob})]);
      log('Copied plot as image/svg+xml to clipboard','info');
      $('readout').innerHTML = '<div class="good">Plot copied to clipboard as SVG ✅</div>';
      return;
    }
    throw new Error('SVG image clipboard not supported');
  } catch(err2){
    log('SVG image copy failed: '+(err2.message||err2),'warn');
  }
  // Fallback: copy SVG markup as text
  try{
    var ser = new XMLSerializer(); var txt = ser.serializeToString(svg);
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(txt);
      log('Copied SVG markup as text to clipboard','warn');
      $('readout').innerHTML = '<div class="warn">Your browser blocked image copy — pasted SVG markup as text instead.</div>';
      return;
    }
    // Legacy execCommand
    var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); var ok=document.execCommand('copy'); document.body.removeChild(ta);
    if(ok){ log('Copied SVG markup via execCommand','warn'); $('readout').innerHTML = '<div class="warn">Copied SVG text (legacy)</div>'; return; }
    throw new Error('execCommand copy failed');
  } catch(err3){
    log('Clipboard copy failed completely: '+(err3.message||err3),'err');
    $('readout').innerHTML = '<div class="bad">Clipboard not available. Try a screenshot or long-press to save.</div>';
  }
}

// ===== App bootstrap =====
function bootstrap(){
  try{
    initTabs();
    buildDefaults();
    renderJunctionList();
    rebuildJourneyMatrix();
    refreshOverlayPickers();
    setDefaultHorizon();
    if($('plotBtn')) $('plotBtn').addEventListener('click', function(){ render(); });
    if($('validateBtn')) $('validateBtn').addEventListener('click', updateDataValidation);
    if($('rebuildMatrix')) $('rebuildMatrix').addEventListener('click', function(){ rebuildJourneyMatrix(); });
    if($('resetDefaultsBtn')) $('resetDefaultsBtn').addEventListener('click', function(){ buildDefaults(); renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); setDefaultHorizon(); render(); updateDataValidation(); });
    var h=$('horizon'); if(h){ h.addEventListener('blur', function(){ state.horizonIsDefault=false; state.horizonSec=num(h.value)||Math.max(60,maxCycle()+20); render(); }); h.addEventListener('change', function(){ state.horizonIsDefault=false; state.horizonSec=num(h.value)||Math.max(60,maxCycle()+20); render(); }); }
    if($('showMainGrid')) $('showMainGrid').addEventListener('change', function(){ render(); });
    if($('copyPlotBtn')) $('copyPlotBtn').addEventListener('click', function(){ copyPlotToClipboard(); });
    if($('addOverlayBtn')) $('addOverlayBtn').addEventListener('click', addOverlayFromUI);
    if($('addCustomOverlayBtn')) $('addCustomOverlayBtn').addEventListener('click', addCustomOverlayFromUI);
    if($('forceInitBtn')) $('forceInitBtn').addEventListener('click', function(){ log('Force init clicked','warn'); try{ bootstrap(); }catch(e){ log('Force init error: '+e.message,'err'); } });
    render();
    log('App initialised','info');
  } catch(e){
    log('Bootstrap error: '+(e.message||e), 'err');
  } finally {
    var b=$('bootBanner'); if(b){ b.textContent='script: DOM ready'; setTimeout(function(){ if(b && b.parentNode) b.parentNode.removeChild(b); }, 2000); }
  }
}

document.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>
