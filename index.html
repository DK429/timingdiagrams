<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Signal Plan Checker v1.0.24.6</title>
<style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#1b1b1b}
header{padding:16px 20px;border-bottom:1px solid #eee;background:#fafafa}
h1{margin:0 0 4px 0;font-size:20px}
.badge{display:inline-block;background:#111;color:#fff;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
main{padding:16px}
.panel{margin-bottom:20px;border:1px solid #e6e6e6;border-radius:8px;padding:12px;background:white}
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.spacer{flex:1}
button{padding:8px 10px;border-radius:6px;border:1px solid #cfcfcf;background:#f6f6f6;cursor:pointer}
button.small{padding:6px 8px;font-size:12px}
button.secondary{background:#eef3ff;border-color:#c2d4ff}
.tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #ddd;border-bottom:none;border-radius:6px 6px 0 0;background:#f2f2f2}
.tab.active{background:white;border-bottom:1px solid white}
.tabPanel{display:none}
.tabPanel.active{display:block}
.dataLayout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.junctionCard{border:1px solid #ececec;border-radius:8px;padding:8px;margin-bottom:10px}
.junctionRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
.stagesTable{width:100%;border-collapse:collapse;margin-top:6px}
.stagesTable th, .stagesTable td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
.stageBtns{display:flex;gap:6px}
.readout{margin-top:8px;padding:8px;border:1px dashed #ddd;border-radius:6px;background:#fcfcfc;font-family:ui-monospace,Consolas,Monaco,monospace}
.diagramHeader{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
#plotHolder{min-height:320px}
svg{border:1px solid #e6e6e6;border-radius:6px;background:#fff;display:block;width:100%}
.legend{margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;font-size:13px}
.legend .item{display:flex;align-items:center;gap:6px}
.legend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #999}
.gridLine{stroke:#e9e9e9;stroke-width:1}
.axisLabel{font-size:10px;fill:#777}
.rowLabel{font-size:12px;fill:#333}
.stageRect{opacity:.95}
.intergreenRect{fill:#c7c7c7;opacity:.5}
.tick5{stroke:#000;stroke-width:1}
.tick1{stroke:#000;stroke-width:1;opacity:.85}
.stageLabel{font-size:11px;fill:#fff;dominant-baseline:middle;text-anchor:middle}
.stageTimeLabel{font-size:10px; fill:#444; text-anchor:middle}
.offsetLabel{font-size:11px; fill:#666}
.coordLine{stroke:#111;stroke-width:2; marker-end:url(#arrow)}
.coordLine.back{stroke-dasharray:3 3}
.arrivalHighlight{fill:#ffd54d;opacity:.25}
.channelGrid{stroke:#e9e9e9;stroke-width:1}
.channelTT{font-size:11px; fill:#333}
.overlayBand{opacity:0.18}
.overlayShade{opacity:0.18}
.debugLog{max-height:220px; overflow:auto; background:#0d1117; color:#c9d1d9; font-family:ui-monospace,Consolas,Monaco,monospace; font-size:12px; padding:8px; border-radius:6px; border:1px solid #30363d}
.debugLog .err{color:#ffb4b4}.debugLog .warn{color:#ffd27f}.debugLog .info{color:#a5d6ff}
#bootBanner{position:fixed;inset:auto 12px 12px auto;background:#0d1117;color:#ffd27f;padding:8px 10px;border-radius:8px;
font-family:ui-monospace,Consolas,Monaco,monospace;font-size:12px;z-index:99999}
summary{cursor:pointer}
.docPolicy{margin:6px 0 0 0; font-size:12px; color:#777}
</style>
</head>
<body>
<header>
  <h1>Signal Plan Checker <span class="badge">v1.0.24.6</span></h1>
  <div>Hotfix: overlay wrap split (no backwards lines) + destination band split.</div>
</header>

<main>
  <nav class="tabs">
    <button type="button" class="tab active" data-tab="dataTab">Data</button>
    <button type="button" class="tab" data-tab="plotTab">Plot</button>
  </nav>

  <section id="dataTab" class="tabPanel active panel">
    <div class="dataLayout">
      <div>
        <div class="toolbar">
          <strong>Junctions</strong>
          <div class="spacer"></div>
          <button type="button" id="addJunctionBtn" class="small">+ Add junction</button>
        </div>
        <div id="junctionList"></div>
      </div>
      <div>
        <div class="toolbar">
          <strong>Journey times (seconds)</strong>
          <div class="spacer"></div>
          <button type="button" id="rebuildMatrix" class="small">Rebuild matrix</button>
        </div>
        <div id="journeyMatrix"></div>
      </div>
    </div>
    <div class="buttons">
      <button type="button" id="resetDefaultsBtn" class="secondary">Reset to defaults</button>
      <button type="button" id="forceInitBtn" class="small">Force init</button>
      <button type="button" id="validateBtn">Validate</button>
      <span class="version">v1.0.24.6</span>
    </div>
    <div id="dataValidation" class="readout" style="margin-left:0;margin-top:10px"></div>

    <div class="buttons">
      <button type="button" id="exportBtn">Export JSON</button>
      <label class="importLabel">Import JSON <input id="importInput" type="file" accept="application/json"/></label>
      <button type="button" id="saveTdBtn">Save TD</button>
      <label class="importLabel">Load TD <input id="loadTdInput" type="file" accept=".td,application/json"/></label>
    </div>
  </section>

  <section id="plotTab" class="tabPanel panel">
    <div class="diagramHeader">
      <div class="toolbar" style="width:100%">
        <label>Diagram horizon (s)
          <input id="horizon" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" value=""/>
        </label>
        <button type="button" id="plotBtn">Plot diagram</button>
        <label><input type="checkbox" id="showMainGrid" checked> Show main grid</label>
        <label>Overruns
          <select id="overrunMode">
            <option value="skip">Skip</option>
            <option value="clip" selected>Clip</option>
          </select>
        </label>
        <div class="spacer"></div>
        <button type="button" id="copyPlotBtn">Copy plot to clipboard</button>
      </div>

      <details id="overlayPanel" open>
        <summary>Overlays</summary>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <label>Origin <select id="ovOrigin"></select></label>
          <label>Stage <select id="ovStage"></select></label>
          <label>Mode
            <select id="ovMode">
              <option value="interval" selected>Interval (whole stage)</option>
              <option value="point">Point (stage start)</option>
              <option value="pointEnd">Point (stage end)</option>
            </select>
          </label>
          <label>Destination <select id="ovDest"></select></label>
          <label>Opacity <input id="ovOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="ovColor" type="color" value="#ff5722"/></label>
          <label><input id="ovRepeat" type="checkbox" checked> Repeat each cycle (stage)</label>
          <button type="button" id="addOverlayBtn">Add overlay</button>
        </div>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-top:6px;border-top:1px dashed #ddd;padding-top:6px">
          <strong>Custom overlay:</strong>
          <label>Origin <select id="coOrigin"></select></label>
          <label>Start (s) <input id="coStart" type="text" inputmode="numeric" pattern="[0-9]*" value="0"/></label>
          <label>End (s) <input id="coEnd" type="text" inputmode="numeric" pattern="[0-9]*" value="20"/></label>
          <label>Destination <select id="coDest"></select></label>
          <label>Opacity <input id="coOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="coColor" type="color" value="#9c27b0"/></label>
          <label><input id="coRepeat" type="checkbox" checked> Repeat each cycle (aligned to origin)</label>
          <button type="button" id="addCustomOverlayBtn">Add custom</button>
        </div>
      </details>
    </div>

    <div id="plotHolder">
      <svg id="diagram" width="100%" height="900" role="img" aria-label="Time–stage diagram"></svg>
    </div>

    <div id="legend" class="legend"></div>
    <div id="readout" class="readout"></div>
  </section>

  <section id="debugSection" class="panel" style="margin-top:10px">
    <details id="debugDetails" open>
      <summary>Debug Log</summary>
      <div id="debugLog" class="debugLog"></div>
      <div class="docPolicy">Docs policy: Every release must update & ship PROMPT.md, BUGS.md, CHANGELOG.md with the code.</div>
      <div style="margin-top:6px; display:flex; gap:8px; align-items:center">
        <button type="button" id="clearDebugBtn" class="small">Clear log</button>
        <span class="axisLabel">Init/Render steps appear here.</span>
      </div>
    </details>
  </section>
</main>

<div id="bootBanner">script: loading…</div>

<script>
function $(id){ return document.getElementById(id); }
function elNS(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }
function setAttrs(ele, attrs){ for(var k in attrs) ele.setAttribute(k, attrs[k]); return ele; }
function num(v){ var s=String(v||'').replace(/[^0-9\\-]/g, ''); var n=Number(s); return isFinite(n)?n:0; }
function log(msg, level){ try{ var box=$('debugLog'); if(!box) return; var div=document.createElement('div'); div.className=level||'info'; var t=(new Date()).toLocaleTimeString(); div.textContent='['+t+'] '+msg; box.appendChild(div); box.scrollTop=box.scrollHeight; }catch(e){} }
(function(){ var b=$('bootBanner'); if(b){ b.textContent='script: running (pre-DOM)'; } })();
window.addEventListener('error', function(e){ log('ERROR: '+(e.message||e.error), 'err'); });
window.addEventListener('unhandledrejection', function(e){ log('PROMISE: '+(e.reason&&e.reason.message?e.reason.message:e.reason), 'err'); });

var state = { junctions: [], journeys: {}, horizonSec: 0, horizonIsDefault: true, overlays: [],
  rowOrder: ['A','B','C','D'], showMainGrid: true, overrunMode: 'clip' };

function initTabs(){
  var tabs=document.querySelectorAll('.tab');
  for(var i=0;i<tabs.length;i++){
    (function(btn){
      btn.addEventListener('click', function(){
        var all=document.querySelectorAll('.tab'); for(var j=0;j<all.length;j++) all[j].classList.remove('active');
        var panels=document.querySelectorAll('.tabPanel'); for(var j=0;j<panels.length;j++) panels[j].classList.remove('active');
        btn.classList.add('active');
        var id=btn.getAttribute('data-tab'); var panel=$(id);
        if(panel) panel.classList.add('active');
        if(id==='plotTab'){ setTimeout(render,0); } // ensure layout applied before render
      });
    })(tabs[i]);
  }
}

function buildDefaults(){
  state.junctions = [];
  function makeJ(id){
    return { id:id, name:'Junction '+id, cycleTimeSec:60, startTimeSec:0,
      stages:[{label:id+'1',durationSec:15},{label:id+'2',durationSec:15},{label:id+'3',durationSec:15}],
      intergreens:[{durationSec:5},{durationSec:5},{durationSec:5}] };
  }
  state.junctions.push(makeJ('A'), makeJ('B'), makeJ('C'), makeJ('D'));
  state.journeys = {'A->B':22,'B->A':24,'B->C':26,'C->B':23,'C->D':28,'D->C':29};
  state.overlays = [];
  setDefaultHorizon();
  log('Default data created','info');
}

function getJ(id){ for(var i=0;i<state.junctions.length;i++){ if(state.junctions[i].id===id) return state.junctions[i]; } return null; }
function alignIntergreens(j){ var n=j.stages.length; while(j.intergreens.length<n) j.intergreens.push({durationSec:0}); if(j.intergreens.length>n) j.intergreens=j.intergreens.slice(0,n); }
function presentRowOrder(){ var out=[]; for(var i=0;i<state.rowOrder.length;i++){ if(getJ(state.rowOrder[i])) out.push(state.rowOrder[i]); } return out; }
function maxCycle(){ var m=0; for(var i=0;i<state.junctions.length;i++) m=Math.max(m, state.junctions[i].cycleTimeSec||0); return m; }
function setDefaultHorizon(){ var def=Math.max(60, maxCycle()+20); var h=$('horizon'); if(state.horizonIsDefault || !num(h.value)){ h.value=String(def); state.horizonSec=def; state.horizonIsDefault=true; } }

function render(){
  var svg=$('diagram'); if(!svg){ log('diagram missing','err'); return; }
  var width = svg.clientWidth || svg.getBoundingClientRect().width || 960;
  var H = state.horizonSec = num($('horizon').value) || Math.max(60, maxCycle()+20);
  if(!$('horizon').value) $('horizon').value=String(H);
  var order = presentRowOrder();
  var MARGIN=60;
  var usableW = Math.max(300, (width - MARGIN - 10));
  var HEIGHT = 20 + (order.length-1)*(30+120) + 30 + 80;
  svg.setAttribute('height', String(HEIGHT));
  svg.innerHTML='';
  var xScale = function(t){ return MARGIN + (t/H)*usableW; };
  function mod(t, m){ return ((t % m) + m) % m; }

  // Background
  var bg = elNS('rect'); setAttrs(bg,{x:0,y:0,width:width,height:HEIGHT,fill:'#fff'}); svg.appendChild(bg);

  // Arrow defs
  var defs=elNS('defs'); defs.id='arrowDefs'; var m=elNS('marker'); m.setAttribute('id','arrow'); m.setAttribute('viewBox','0 0 10 10'); m.setAttribute('refX','8'); m.setAttribute('refY','5'); m.setAttribute('markerWidth','6'); m.setAttribute('markerHeight','6'); m.setAttribute('orient','auto'); var p=elNS('path'); p.setAttribute('d','M 0 0 L 10 5 L 0 10 z'); p.setAttribute('fill','context-stroke'); m.appendChild(p); defs.appendChild(m); svg.appendChild(defs);

  // Grid
  for(var t=0;t<=H;t+=10){
    var ln=elNS('line'); setAttrs(ln,{x1:xScale(t),y1:8,x2:xScale(t),y2:HEIGHT-8,stroke:'#e9e9e9','stroke-width':1}); svg.appendChild(ln);
    if(t%30===0){ var tx=elNS('text'); setAttrs(tx,{x:xScale(t)+2,y:12,fill:'#777','font-size':'10px'}); tx.textContent=t+'s'; svg.appendChild(tx); }
  }

  // Rows
  var rowYTops={};
  for(var r=0;r<order.length;r++){
    var j=getJ(order[r]); if(!j) continue;
    var yTop=20 + r*(30+120); var yBandTop=yTop+10, yBandBot=yBandTop+30;
    rowYTops[j.id]=yBandTop;
    var lbl=elNS('text'); setAttrs(lbl,{x:10,y:yTop+4,fill:'#333','font-size':'12px'}); lbl.textContent=j.name; svg.appendChild(lbl);
    var offlbl=elNS('text'); setAttrs(offlbl,{x:10,y:yTop+16,fill:'#666','font-size':'11px'}); offlbl.textContent='Offset: '+(j.startTimeSec||0)+'s'; svg.appendChild(offlbl);
    // ticks
    for(var t1=0;t1<=H;t1+=1){
      var x=xScale(t1);
      var l1=elNS('line'); setAttrs(l1,{x1:x,y1:yBandTop-3,x2:x,y2:yBandTop,stroke:'#000','stroke-width':1,opacity:.85}); svg.appendChild(l1);
      var l2=elNS('line'); setAttrs(l2,{x1:x,y1:yBandBot,x2:x,y2:yBandBot+3,stroke:'#000','stroke-width':1,opacity:.85}); svg.appendChild(l2);
    }
    for(var t5=0;t5<=H;t5+=5){
      var x5=xScale(t5);
      var L1=elNS('line'); setAttrs(L1,{x1:x5,y1:yBandTop-6,x2:x5,y2:yBandTop,stroke:'#000','stroke-width':1}); svg.appendChild(L1);
      var L2=elNS('line'); setAttrs(L2,{x1:x5,y1:yBandBot,x2:x5,y2:yBandBot+6,stroke:'#000','stroke-width':1}); svg.appendChild(L2);
    }
    // Simple bars (no wrap split in this hotfix)
    var C=j.cycleTimeSec, t=0, t0=j.startTimeSec||0;
    while(t<=H){
      for(var i=0;i<j.stages.length;i++){
        var sDur=j.stages[i].durationSec, ig=j.intergreens[i].durationSec||0;
        var s0=mod(t + mod(t0,C), H), s1=mod(s0 + sDur, H);
        if(s1 < s0){
          var r1=elNS('rect'); setAttrs(r1,{x:xScale(s0),y:yBandTop,width:xScale(H)-xScale(s0),height:30,fill:'#2e7d32',opacity:.95}); svg.appendChild(r1);
          var r2=elNS('rect'); setAttrs(r2,{x:xScale(0),y:yBandTop,width:xScale(s1)-xScale(0),height:30,fill:'#43a047',opacity:.95}); svg.appendChild(r2);
        } else {
          var rect=elNS('rect'); setAttrs(rect,{x:xScale(s0),y:yBandTop,width:Math.max(0,xScale(s1)-xScale(s0)),height:30,fill:'#388e3c',opacity:.95}); svg.appendChild(rect);
        }
        // intergreen
        var ig0 = s1, ig1 = mod(ig0 + ig, H);
        if(ig>0){
          if(ig1 < ig0){
            var igA=elNS('rect'); setAttrs(igA,{x:xScale(ig0),y:yBandTop,width:xScale(H)-xScale(ig0),height:30,fill:'#c7c7c7',opacity:.5}); svg.appendChild(igA);
            var igB=elNS('rect'); setAttrs(igB,{x:xScale(0),y:yBandTop,width:xScale(ig1)-xScale(0),height:30,fill:'#c7c7c7',opacity:.5}); svg.appendChild(igB);
          } else {
            var igR=elNS('rect'); setAttrs(igR,{x:xScale(ig0),y:yBandTop,width:Math.max(0,xScale(ig1)-xScale(ig0)),height:30,fill:'#c7c7c7',opacity:.5}); svg.appendChild(igR);
          }
        }
        t += sDur + ig;
      }
    }
    // Cycle markers
    for(var tt=0; tt<=H; tt+=C){
      var xl=xScale(tt); var ln2=elNS('line'); setAttrs(ln2,{x1:xl,y1:yBandTop-6,x2:xl,y2:yBandBot+6,stroke:'#e53935','stroke-width':'2'}); svg.appendChild(ln2);
    }
    var yBottomLbl=yBandBot+16;
    for(var ttt=0; ttt<=H; ttt+=5){
      var tx3=elNS('text'); setAttrs(tx3,{x:xScale(ttt)+2,y:yBottomLbl,fill:'#777','font-size':'10px'}); tx3.textContent=String(ttt%C)+'s'; svg.appendChild(tx3);
    }
  }

  // Overlay helpers with wrap-aware splitting
  function interp(yA, yB, frac){ return yA + (yB - yA) * frac; }
  function drawWrappedLine(tA, yA, tB, yB, color, op){
    var a = mod(tA, H), b = mod(tB, H);
    var dt = (b - a + H) % H;
    if(dt === 0){ // vertical-ish wrap; draw small marker
      var x = xScale(a); var ln=elNS('line'); setAttrs(ln,{x1:x,y1:yA-4,x2:x,y2:yA+4,stroke:color,'stroke-width':2,'marker-end':'url(#arrow)',opacity:op||0.9}); svg.appendChild(ln); return;
    }
    if(b >= a){
      var ln=elNS('line'); setAttrs(ln,{x1:xScale(a),y1:yA,x2:xScale(b),y2:yB,stroke:color,'stroke-width':2,'marker-end':'url(#arrow)',opacity:op||0.9}); svg.appendChild(ln);
    } else {
      // split at H: a..H and 0..b
      var frac = (H - a) / dt;
      var ySplit = interp(yA, yB, frac);
      var ln1=elNS('line'); setAttrs(ln1,{x1:xScale(a),y1:yA,x2:xScale(H),y2:ySplit,stroke:color,'stroke-width':2,'marker-end':'url(#arrow)',opacity:op||0.9}); svg.appendChild(ln1);
      var ln2=elNS('line'); setAttrs(ln2,{x1:xScale(0),y1:ySplit,x2:xScale(b),y2:yB,stroke:color,'stroke-width':2,'marker-end':'url(#arrow)',opacity:op||0.9}); svg.appendChild(ln2);
    }
  }
  function drawWrappedBand(tStartArr, tEndArr, yTop, color){
    var a = mod(tStartArr, H), b = mod(tEndArr, H);
    if(b >= a){
      var r=elNS('rect'); setAttrs(r,{x:xScale(a),y:yTop,width:Math.max(0, xScale(b)-xScale(a)),height:30,fill:color,opacity:.18}); svg.appendChild(r);
    } else {
      var r1=elNS('rect'); setAttrs(r1,{x:xScale(a),y:yTop,width:xScale(H)-xScale(a),height:30,fill:color,opacity:.18}); svg.appendChild(r1);
      var r2=elNS('rect'); setAttrs(r2,{x:xScale(0),y:yTop,width:xScale(b)-xScale(0),height:30,fill:color,opacity:.18}); svg.appendChild(r2);
    }
  }

  // Overlays
  function pathTravel(a,b){
    var ids=presentRowOrder(); var ai=ids.indexOf(a), bi=ids.indexOf(b); if(ai===-1||bi===-1) return 0;
    var sum=0; if(ai<bi){ for(var k=ai;k<bi;k++) sum+= (state.journeys[ids[k]+'->'+ids[k+1]]||0); }
                else if(ai>bi){ for(var k=ai;k>bi;k--) sum+= (state.journeys[ids[k]+'->'+ids[k-1]]||0); }
    return sum;
  }
  function stageOffsets(j){ var arr=[], t=0; for(var i=0;i<j.stages.length;i++){ arr.push(t); t+=j.stages[i].durationSec + (j.intergreens[i].durationSec||0); } return arr; }

  for(var oi=0; oi<state.overlays.length; oi++){
    var ov=state.overlays[oi]; var J0=getJ(ov.origin), J1=getJ(ov.dest); if(!J0||!J1) continue;
    var travel=pathTravel(ov.origin, ov.dest);
    var y0=(rowYTops[J0.id]||0)+15, y1=(rowYTops[J1.id]||0)+15;
    var C=J0.cycleTimeSec, off=(J0.startTimeSec||0);
    var color=ov.color||'#ff5722', op=parseFloat(ov.opacity||'0.8')||0.8;
    var times=[];
    if(ov.kind==='stage'){
      var idx=ov.stageIndex||0; var offs=0; for(var si=0;si<idx;si++) offs+=J0.stages[si].durationSec + (J0.intergreens[si].durationSec||0);
      var sDur=J0.stages[idx].durationSec||0;
      var kMin=Math.floor((-off - offs)/C)-1, kMax=Math.ceil((H - off - offs)/C)+1;
      for(var k=kMin;k<=kMax;k++){
        var tStart=off+offs+k*C, tEnd=tStart+sDur;
        if(ov.mode==='interval'){ if(ov.repeat || (tStart<=H && tEnd>=0)) times.push({tStart,tEnd}); }
        else if(ov.mode==='point'){ times.push({tStart,tEnd:tStart}); }
        else if(ov.mode==='pointEnd'){ times.push({tStart:tEnd,tEnd:tEnd}); }
      }
    } else if(ov.kind==='custom'){
      var cs = (ov.cStart|0), ce=(ov.cEnd|0), base=off;
      var kMin=-1, kMax=Math.ceil(H/C)+1;
      for(var k=kMin;k<=kMax;k++){ var tStart=base+cs+k*C, tEnd=base+ce+k*C; if(ov.repeat || (tStart<=H && tEnd>=0)) times.push({tStart,tEnd}); }
    }
    for(var ti=0;ti<times.length;ti++){
      var e=times[ti]; if(e.tEnd<0 || e.tStart>H) continue;
      var a0=e.tStart+travel, a1=e.tEnd+travel;
      // Front (start) line
      drawWrappedLine(e.tStart, y0, a0, y1, color, op);
      if(ov.mode==='interval'){
        // Back (end) line
        drawWrappedLine(e.tEnd, y0, a1, y1, color, op*0.85);
        // Destination shading, split if wrapped
        var yTop=(rowYTops[J1.id]||0);
        drawWrappedBand(a0, a1, yTop, color);
      }
    }
  }

  log('Plot rendered (W='+width+' H='+H+'s)','info');
}

function renderJunctionList(){
  var container=$('junctionList'); container.innerHTML='';
  function alignIntergreens(j){ var n=j.stages.length; while(j.intergreens.length<n) j.intergreens.push({durationSec:0}); if(j.intergreens.length>n) j.intergreens=j.intergreens.slice(0,n); }
  for(var i=0;i<state.junctions.length;i++){
    var j=state.junctions[i]; alignIntergreens(j);
    var card=document.createElement('div'); card.className='junctionCard';
    card.innerHTML=''
      +'<div class="junctionRow">'
      +'<label>Id <input value="'+j.id+'" disabled></label>'
      +'<label>Name <input data-bind="name" data-id="'+j.id+'" value="'+j.name+'"></label>'
      +'<label>Start offset (s) <input data-bind="start" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.startTimeSec+'"></label>'
      +'</div>'
      +'<div class="junctionRow">'
      +'<label>Cycle time (s) <input data-bind="cycle" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.cycleTimeSec+'"></label>'
      +'</div>'
      +'<h4>Stages</h4>'
      +'<table class="stagesTable"><thead><tr><th>Label</th><th>Duration (s)</th><th>Intergreen after (s)</th><th></th></tr></thead>'
      +'<tbody id="stBody_'+j.id+'"></tbody></table>';
    container.appendChild(card);
    var tbody=card.querySelector('#stBody_'+j.id+'');
    for(var k=0;k<j.stages.length;k++){
      var s=j.stages[k], ig=j.intergreens[k].durationSec||0;
      var tr=document.createElement('tr');
      tr.innerHTML='<td><input data-st="label" data-id="'+j.id+'" data-idx="'+k+'" value="'+s.label+'"></td>'
        +'<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="dur" data-id="'+j.id+'" data-idx="'+k+'" value="'+s.durationSec+'"></td>'
        +'<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="ig" data-id="'+j.id+'" data-idx="'+k+'" value="'+ig+'"></td>';
      tbody.appendChild(tr);
    }
  }
  var binds=container.querySelectorAll('input[data-bind]');
  for(var b=0;b<binds.length;b++){ (function(inp){
    function commit(){
      var j=getJ(inp.getAttribute('data-id')); if(!j) return;
      var bind=inp.getAttribute('data-bind');
      if(bind==='name') j.name=inp.value;
      if(bind==='start') j.startTimeSec=num(inp.value);
      if(bind==='cycle'){ j.cycleTimeSec=num(inp.value); if(state.horizonIsDefault){ setDefaultHorizon(); } }
      render();
    }
    inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
  })(binds[b]); }
  var stInputs=container.querySelectorAll('input[data-st]');
  for(var si=0; si<stInputs.length; si++){ (function(inp){
    function commit(){
      var j=getJ(inp.getAttribute('data-id')); var idx=Number(inp.getAttribute('data-idx'));
      if(inp.getAttribute('data-st')==='label') j.stages[idx].label = inp.value;
      if(inp.getAttribute('data-st')==='dur') j.stages[idx].durationSec = num(inp.value);
      if(inp.getAttribute('data-st')==='ig') j.intergreens[idx].durationSec = num(inp.value);
      render();
    }
    inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
  })(stInputs[si]); }
  log('Junction list rendered','info');
}

function refreshOverlayPickers(){
  function fillSel(sel){
    if(!sel) return;
    var cur=sel.value; sel.innerHTML='';
    for(var i=0;i<state.rowOrder.length;i++){ var id=state.rowOrder[i]; var j=getJ(id); if(j){ var opt=document.createElement('option'); opt.value=id; opt.textContent=j.name; sel.appendChild(opt);} }
    if(cur && getJ(cur)) sel.value=cur;
  }
  fillSel($('ovOrigin')); fillSel($('ovDest')); fillSel($('coOrigin')); fillSel($('coDest'));
  function fillStages(){ var s=$('ovStage'); s.innerHTML=''; var o=$('ovOrigin').value; var j=getJ(o); if(j){ for(var i=0;i<j.stages.length;i++){ var op=document.createElement('option'); op.value=String(i); op.textContent=j.stages[i].label; s.appendChild(op);} } }
  fillStages(); if(!$('ovOrigin')._wired){ $('ovOrigin').addEventListener('change', fillStages); $('ovOrigin')._wired=true; }
}

function addOverlayFromUI(){
  var origin=$('ovOrigin').value, dest=$('ovDest').value, idx=parseInt($('ovStage').value||'0',10), mode=$('ovMode').value;
  var col=$('ovColor').value, op=parseFloat($('ovOpacity').value||'0.8'); var rpt=$('ovRepeat').checked;
  state.overlays.push({kind:'stage', origin:origin, dest:dest, stageIndex:idx, mode:mode, color:col, opacity:op, repeat:rpt});
  log('Overlay added: '+origin+' '+getJ(origin).stages[idx].label+' → '+dest+' ('+mode+')','info');
  render();
}
function addCustomOverlayFromUI(){
  var origin=$('coOrigin').value, dest=$('coDest').value;
  var cs=num($('coStart').value||0), ce=num($('coEnd').value||0);
  var col=$('coColor').value, op=parseFloat($('coOpacity').value||'0.8'); var rpt=$('coRepeat').checked;
  state.overlays.push({kind:'custom', origin:origin, dest:dest, cStart:cs, cEnd:ce, color:col, opacity:op, repeat:rpt});
  log('Custom overlay added: '+origin+' ['+cs+','+ce+'] → '+dest,'info');
  render();
}

async function copyPlotToClipboard(){
  log('Copy plot clicked','info');
  var svg=$('diagram'); if(!svg){ log('No diagram to copy','err'); return; }
  try{
    var bbox=svg.getBoundingClientRect();
    var width=Math.max(1, Math.floor(bbox.width)), height=Math.max(1, Math.floor(bbox.height));
    var clone=svg.cloneNode(true); clone.setAttribute('width', width); clone.setAttribute('height', height);
    var ser=new XMLSerializer(); var svgStr=ser.serializeToString(clone);
    var svgBlob=new Blob([svgStr],{type:'image/svg+xml;charset=utf-8'});
    var url=URL.createObjectURL(svgBlob); var img=new Image();
    var scale=2; var canvas=document.createElement('canvas'); canvas.width=width*scale; canvas.height=height*scale; var ctx=canvas.getContext('2d');
    await new Promise(function(res,rej){ img.onload=function(){ try{ ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0,width,height); res(); }catch(e){ rej(e);} finally{ URL.revokeObjectURL(url);} }; img.onerror=rej; img.src=url; });
    const blob=await new Promise(res=>canvas.toBlob(res,'image/png'));
    if(navigator.clipboard && window.ClipboardItem){ await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]); $('readout').innerHTML='<div class="good">Plot copied to clipboard as image ✅</div>'; log('Copied as image/png','info'); return; }
    throw new Error('PNG clipboard unsupported');
  }catch(e){ log('PNG copy failed: '+(e.message||e),'warn'); }
  try{
    var ser=new XMLSerializer(); var txt=ser.serializeToString(svg);
    if(navigator.clipboard && window.ClipboardItem){ var blob=new Blob([txt],{type:'image/svg+xml'}); await navigator.clipboard.write([new ClipboardItem({'image/svg+xml':blob})]); $('readout').innerHTML='<div class="good">Plot copied to clipboard as SVG ✅</div>'; log('Copied as SVG image','info'); return; }
    throw new Error('SVG image clipboard unsupported');
  }catch(e){ log('SVG image copy failed: '+(e.message||e),'warn'); }
  try{
    var ser2=new XMLSerializer(); var txt2=ser2.serializeToString(svg);
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(txt2); $('readout').innerHTML='<div class="warn">Copied SVG markup as text.</div>'; log('Copied as text/svg','warn'); return; }
    var ta=document.createElement('textarea'); ta.value=txt2; document.body.appendChild(ta); ta.select(); var ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){ $('readout').innerHTML='<div class="warn">Copied SVG text (legacy)</div>'; log('Copied via execCommand','warn'); return; }
    throw new Error('execCommand failed');
  }catch(e){ $('readout').innerHTML='<div class="bad">Clipboard not available. Try a screenshot.</div>'; log('Clipboard copy failed completely: '+(e.message||e),'err'); }
}

function bootstrap(){
  try{
    initTabs();
    buildDefaults();
    renderJunctionList();
    refreshOverlayPickers();
    setDefaultHorizon();
    $('plotBtn').addEventListener('click', render);
    $('copyPlotBtn').addEventListener('click', copyPlotToClipboard);
    $('addOverlayBtn').addEventListener('click', addOverlayFromUI);
    $('addCustomOverlayBtn').addEventListener('click', addCustomOverlayFromUI);
    $('horizon').addEventListener('blur', function(){ state.horizonIsDefault=false; state.horizonSec=num(this.value)||Math.max(60,maxCycle()+20); render(); });
    $('horizon').addEventListener('change', function(){ state.horizonIsDefault=false; state.horizonSec=num(this.value)||Math.max(60,maxCycle()+20); render(); });
    log('App initialised','info');
  }catch(e){
    log('Bootstrap error: '+(e.message||e),'err');
  }finally{
    var b=$('bootBanner'); if(b){ b.textContent='script: DOM ready'; setTimeout(function(){ if(b&&b.parentNode) b.parentNode.removeChild(b); }, 2000); }
  }
}
document.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>
