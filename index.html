<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Signal Plan Checker v1.0.18</title>
<style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#1b1b1b}
header{padding:16px 20px;border-bottom:1px solid #eee;background:#fafafa}
h1{margin:0 0 4px 0;font-size:20px}
main{padding:16px}
.panel{margin-bottom:20px;border:1px solid #e6e6e6;border-radius:8px;padding:12px;background:white}
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.spacer{flex:1}
button{padding:8px 10px;border-radius:6px;border:1px solid #cfcfcf;background:#f6f6f6;cursor:pointer}
button.small{padding:6px 8px;font-size:12px}
button.secondary{background:#eef3ff;border-color:#c2d4ff}
button:hover{background:#efefef}
label{display:flex;flex-direction:column;gap:4px;font-size:13px}
input, select, textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
.tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #ddd;border-bottom:none;border-radius:6px 6px 0 0;background:#f2f2f2}
.tab.active{background:white;border-bottom:1px solid white}
.tabPanel{display:none}
.tabPanel.active{display:block}
.dataLayout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.junctionCard{border:1px solid #ececec;border-radius:8px;padding:8px;margin-bottom:10px}
.junctionRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
.stagesTable{width:100%;border-collapse:collapse;margin-top:6px}
.stagesTable th, .stagesTable td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
.stageBtns{display:flex;gap:6px}
.readout{margin-top:8px;padding:8px;border:1px dashed #ddd;border-radius:6px;background:#fcfcfc;font-family:ui-monospace,Consolas,Monaco,monospace}
.diagramHeader{display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px}
.diagramHeader .pairPickers{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
svg{border:1px solid #e6e6e6;border-radius:6px;background:#fff}
.legend{margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;font-size:13px}
.legend .item{display:flex;align-items:center;gap:6px}
.legend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #999}
.gridLine{stroke:#e9e9e9;stroke-width:1}
.axisLabel{font-size:10px;fill:#777}
.rowLabel{font-size:12px;fill:#333}
.stageRect{opacity:.95}
.intergreenRect{fill:#c7c7c7;opacity:.5}
.tick5{stroke:#000;stroke-width:1}
.tick1{stroke:#000;stroke-width:1;opacity:.85}
.stageLabel{font-size:11px;fill:#fff;dominant-baseline:middle;text-anchor:middle}
.stageTimeLabel{font-size:10px; fill:#444; text-anchor:middle}
.offsetLabel{font-size:11px; fill:#666}
.coordLine{stroke:#111;stroke-width:2}
.coordLine.back{stroke-dasharray:3 3}
.arrivalHighlight{fill:#ffd54d;opacity:.35}
.channelGrid{stroke:#e9e9e9;stroke-width:1}
.channelTT{font-size:11px; fill:#333}
.debugLog{max-height:180px; overflow:auto; background:#0d1117; color:#c9d1d9; font-family:ui-monospace,Consolas,Monaco,monospace; font-size:12px; padding:8px; border-radius:6px; border:1px solid #30363d}
.debugLog .err{color:#ffb4b4}.debugLog .warn{color:#ffd27f}.debugLog .info{color:#a5d6ff}
.debugLog:empty::before{content:'(no messages yet)'; color:#9aa6b2}
</style>
</head>
<body>
<header>
  <h1>Signal Plan Checker</h1>
  <p>v1.0.18 — single-file build for iPad; timing diagrams with overlays, per-row cycle markers, and debug log.</p>
</header>

<main>
  <nav class="tabs">
    <button type="button" class="tab active" data-tab="dataTab">Data</button>
    <button type="button" class="tab" data-tab="plotTab">Plot</button>
  </nav>

  <section id="dataTab" class="tabPanel active panel">
    <div class="dataLayout">
      <div>
        <div class="toolbar">
          <strong>Junctions</strong>
          <div class="spacer"></div>
          <button type="button" id="addJunctionBtn" class="small">+ Add junction</button>
        </div>
        <div id="junctionList"></div>
      </div>
      <div>
        <div class="toolbar">
          <strong>Journey times (seconds)</strong>
          <div class="spacer"></div>
          <button type="button" id="rebuildMatrix" class="small">Rebuild matrix</button>
        </div>
        <div id="journeyMatrix"></div>
      </div>
    </div>
    <div class="buttons">
      <button type="button" id="resetDefaultsBtn" class="secondary">Reset to defaults</button> <button type="button" id="forceInitBtn" class="small">Force init</button>
      <button type="button" id="validateBtn">Validate</button>
      <span class="version">v1.0.18</span>
    </div>
    <div id="dataValidation" class="readout" style="margin-left:0;margin-top:10px"></div>

    <div class="buttons">
      <button type="button" id="exportBtn">Export JSON</button>
      <label class="importLabel">Import JSON <input id="importInput" type="file" accept="application/json"/></label>
      <button type="button" id="saveTdBtn">Save TD</button>
      <label class="importLabel">Load TD <input id="loadTdInput" type="file" accept=".td,application/json"/></label>
    </div>
  </section>

  <section id="plotTab" class="tabPanel panel">
    <div class="diagramHeader">
      <div class="pairPickers">
        <label>Diagram horizon (s)
          <input id="horizon" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" value=""/>
        </label>
        <button type="button" id="plotBtn">Plot diagram</button>
        <label><input type="checkbox" id="showMainGrid" checked> Show main grid</label>
        <label>Overruns
          <select id="overrunMode">
            <option value="skip">Skip</option>
            <option value="clip" selected>Clip</option>
          </select>
        </label>
      </div>

      <div class="pairPickers">
        <label>Wrap mode
          <select id="wrapMode">
            <option value="phase">Phase-aligned</option>
            <option value="mod" selected>Modulo</option>
            <option value="none">None (no wrap)</option>
          </select>
        </label>
        <label>Phase wrap by
          <select id="phaseWrapBy">
            <option value="origin" selected>Origin cycle</option>
            <option value="destination">Destination cycle</option>
          </select>
        </label>
      </div>

      <details id="overlayPanel">
        <summary>Overlays</summary>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <label>Origin <select id="ovOrigin"></select></label>
          <label>Stage <select id="ovStage"></select></label>
          <label>Mode
            <select id="ovMode">
              <option value="interval" selected>Interval (whole stage)</option>
              <option value="point">Point (stage start)</option>
              <option value="pointEnd">Point (stage end)</option>
            </select>
          </label>
          <label>Destination <select id="ovDest"></select></label>
          <label>Opacity <input id="ovOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="ovColor" type="color" value="#ff5722"/></label>
          <label><input id="ovRepeat" type="checkbox" checked> Repeat each cycle (stage)</label>
          <button type="button" id="addOverlayBtn">Add overlay</button>
        </div>
        <div class="overlayForm" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-top:6px;border-top:1px dashed #ddd;padding-top:6px">
          <strong>Custom overlay:</strong>
          <label>Origin <select id="coOrigin"></select></label>
          <label>Start (s) <input id="coStart" type="text" inputmode="numeric" pattern="[0-9]*" value="0"/></label>
          <label>End (s) <input id="coEnd" type="text" inputmode="numeric" pattern="[0-9]*" value="20"/></label>
          <label>Destination <select id="coDest"></select></label>
          <label>Opacity <input id="coOpacity" type="range" min="0.1" max="1" step="0.05" value="0.8"/></label>
          <label>Color <input id="coColor" type="color" value="#9c27b0"/></label>
          <label><input id="coRepeat" type="checkbox" checked> Repeat each cycle (aligned to origin)</label>
          <button type="button" id="addCustomOverlayBtn">Add custom</button>
        </div>
      </details>
    </div>

    <div id="plotHolder">
      <svg id="diagram" width="100%" height="900" role="img" aria-label="Time–stage diagram"></svg>
    </div>

    <div id="legend" class="legend"></div>
    <div id="readout" class="readout"></div>
  </section>

  <section id="debugSection" class="panel" style="margin-top:10px">
    <details id="debugDetails" open>
      <summary>Debug Log</summary>
      <div id="debugLog" class="debugLog"></div>
      <div style="margin-top:6px; display:flex; gap:8px; align-items:center">
        <button type="button" id="clearDebugBtn" class="small">Clear log</button>
        <span class="axisLabel">Tip: Errors appear here on iPad.</span>
      </div>
    </details>
  </section>
</main>

<footer>
  <small>© 2025 — Signal Plan Checker v1.0.18</small>
</footer>

<script>
(function(){
  // Basic helpers
  function $(id){ return document.getElementById(id); }
  function elNS(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }
  function setAttrs(ele, attrs){ for(var k in attrs) ele.setAttribute(k, attrs[k]); return ele; }
  function num(v){ var s=String(v||'').replace(/[^0-9]/g,''); var n=Number(s); return isFinite(n)?n:0; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function posMod(a,m){ var r = a % m; return r<0? r+m : r; }

  // Debug
  function log(msg, level){ var box=$('debugLog'); if(!box) return; var div=document.createElement('div'); div.className=level||'info'; var t=(new Date()).toLocaleTimeString(); div.textContent='['+t+'] '+msg; box.appendChild(div); box.scrollTop=box.scrollHeight; }
  window.addEventListener('error', function(e){ log('Error: '+e.message, 'err'); });
  window.addEventListener('unhandledrejection', function(e){ log('Unhandled rejection: '+e.reason, 'err'); });
  document.addEventListener('DOMContentLoaded', function(){ var c=$('clearDebugBtn'); if(c) c.addEventListener('click', function(){ var b=$('debugLog'); if(b) b.innerHTML=''; }); });

  // State
  var state = {
    junctions: [], journeys: {}, horizonSec: 0, horizonIsDefault: true, overlays: [],
    rowOrder: ['A','B','C','D'], showMainGrid: true, overrunMode: 'clip', phaseWrapMode: 'origin', wrapMode: 'mod'
  };

  // Tabs
  function initTabs(){
    var tabs = document.querySelectorAll('.tab');
    for(var i=0;i<tabs.length;i++){
      (function(btn){
        btn.addEventListener('click', function(){
          var all = document.querySelectorAll('.tab'); for(var j=0;j<all.length;j++) all[j].classList.remove('active');
          var panels = document.querySelectorAll('.tabPanel'); for(var j=0;j<panels.length;j++) panels[j].classList.remove('active');
          btn.classList.add('active');
          var id = btn.getAttribute('data-tab'); var panel = document.getElementById(id); if(panel) panel.classList.add('active');
          if(id==='plotTab'){ requestAnimationFrame(render); }
        });
      })(tabs[i]);
    }
  }

  // Seed defaults (direct populate)
  function buildDefaults(){
    try{
      state.junctions = [];
      function makeJ(id){
        return { id:id, name:'Junction '+id, cycleTimeSec:60, startTimeSec:0,
          stages:[{label:id+'1',durationSec:15},{label:id+'2',durationSec:15},{label:id+'3',durationSec:15}],
          intergreens:[{durationSec:5},{durationSec:5},{durationSec:5}] };
      }
      state.junctions.push(makeJ('A'), makeJ('B'), makeJ('C'), makeJ('D'));
      state.journeys = {'A->B':22,'B->A':24,'B->C':26,'C->B':23,'C->D':28,'D->C':29};
      setDefaultHorizon();
      renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); renderLegend(); updateDataValidation();
      log('Default data seeded.', 'info');
    }catch(e){ log('Seeding error: '+e.message, 'err'); }
  }

  // Data tab render & handlers
  function alignIntergreens(j){
    var n=j.stages.length; while(j.intergreens.length<n) j.intergreens.push({durationSec:0});
    if(j.intergreens.length>n) j.intergreens = j.intergreens.slice(0,n);
  }
  function updateTotalsForJunction(id){
    var j = getJ(id); if(!j) return;
    var st=0, ig=0; for(var i=0;i<j.stages.length;i++){ st+=num(j.stages[i].durationSec); ig+=num(j.intergreens[i].durationSec||0); }
    var el = document.getElementById('tot_'+id); if(el){ el.textContent = 'Total used: '+(st+ig)+'s (stages '+st+'s + intergreens '+ig+'s) / cycle '+j.cycleTimeSec+'s'; }
  }
  function getJ(id){ for(var i=0;i<state.junctions.length;i++){ if(state.junctions[i].id===id) return state.junctions[i]; } return null; }
  function renderJunctionList(){
    var container=$('junctionList'); if(!container) return; container.innerHTML='';
    for(var ji=0; ji<state.junctions.length; ji++){
      var j = state.junctions[ji]; alignIntergreens(j);
      var card = document.createElement('div'); card.className='junctionCard';
      card.innerHTML = ''
      + '<div class="junctionRow">'
      + '<label>Id <input value="'+j.id+'" disabled></label>'
      + '<label>Name <input data-bind="name" data-id="'+j.id+'" value="'+j.name+'"></label>'
      + '<label>Start offset (s) <input data-bind="start" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.startTimeSec+'"></label>'
      + '</div>'
      + '<div class="junctionRow">'
      + '<label>Cycle time (s) <input data-bind="cycle" data-id="'+j.id+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+j.cycleTimeSec+'"></label>'
      + '</div>'
      + '<h4>Stages</h4>'
      + '<table class="stagesTable"><thead><tr><th>Label</th><th>Duration (s)</th><th>Intergreen after (s)</th><th></th></tr></thead>'
      + '<tbody id="stBody_'+j.id+'"></tbody></table>'
      + '<div class="stageBtns"><button type="button" class="small" data-add-stage="'+j.id+'">+ Add stage</button>'
      + (state.junctions.length>2 ? '<button type="button" class="small" data-remove-j="'+j.id+'">Remove junction</button>' : '')
      + '</div>'
      + '<div class="totalsRow" id="tot_'+j.id+'" style="margin-top:6px;font-size:12px;color:#555"></div>';
      container.appendChild(card);
      var tbody = card.querySelector('#stBody_'+j.id);
      for(var i=0;i<j.stages.length;i++){
        var s=j.stages[i], ig=j.intergreens[i].durationSec||0;
        var tr=document.createElement('tr');
        tr.innerHTML = '<td><input data-st="label" data-id="'+j.id+'" data-idx="'+i+'" value="'+s.label+'"></td>'
          + '<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="dur" data-id="'+j.id+'" data-idx="'+i+'" value="'+s.durationSec+'"></td>'
          + '<td><input type="text" inputmode="numeric" pattern="[0-9]*" data-st="ig" data-id="'+j.id+'" data-idx="'+i+'" value="'+ig+'"></td>'
          + '<td><button type="button" class="small" data-del-stage="'+j.id+'" data-idx="'+i+'">✕</button></td>';
        tbody.appendChild(tr);
      }
    }
    // handlers
    var binds = container.querySelectorAll('input[data-bind]');
    for(var b=0;b<binds.length;b++){
      (function(inp){
        function commit(){
          var j=getJ(inp.getAttribute('data-id')); if(!j) return;
          var bind=inp.getAttribute('data-bind');
          if(bind==='name') j.name = inp.value;
          if(bind==='start') j.startTimeSec = num(inp.value);
          if(bind==='cycle'){ j.cycleTimeSec = num(inp.value); if(state.horizonIsDefault){ setDefaultHorizon(); } }
          rebuildJourneyMatrix(); refreshOverlayPickers(); render(); updateDataValidation(); updateTotalsForJunction(j.id);
        }
        inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
      })(binds[b]);
    }
    var stInputs = container.querySelectorAll('input[data-st]');
    for(var si=0;si<stInputs.length;si++){
      (function(inp){
        function commit(){
          var j=getJ(inp.getAttribute('data-id')); var idx=Number(inp.getAttribute('data-idx'));
          if(inp.getAttribute('data-st')==='label') j.stages[idx].label = inp.value;
          if(inp.getAttribute('data-st')==='dur') j.stages[idx].durationSec = num(inp.value);
          if(inp.getAttribute('data-st')==='ig') j.intergreens[idx].durationSec = num(inp.value);
          refreshOverlayPickers(); render(); updateDataValidation(); updateTotalsForJunction(j.id);
        }
        inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
      })(stInputs[si]);
    }
    var addBtns = container.querySelectorAll('[data-add-stage]');
    for(var ai=0;ai<addBtns.length;ai++){
      addBtns[ai].addEventListener('click', function(ev){
        var id=ev.currentTarget.getAttribute('data-add-stage'); var j=getJ(id);
        var n=j.stages.length+1; j.stages.push({label:id+n, durationSec:10}); j.intergreens.push({durationSec:2});
        renderJunctionList(); refreshOverlayPickers(); render(); updateDataValidation();
      });
    }
    var delBtns = container.querySelectorAll('[data-del-stage]');
    for(var di=0;di<delBtns.length;di++){
      delBtns[di].addEventListener('click', function(ev){
        var id=ev.currentTarget.getAttribute('data-del-stage'); var idx=Number(ev.currentTarget.getAttribute('data-idx'));
        var j=getJ(id); j.stages.splice(idx,1); j.intergreens.splice(idx,1);
        renderJunctionList(); refreshOverlayPickers(); render(); updateDataValidation();
      });
    }
    var remBtns = container.querySelectorAll('[data-remove-j]');
    for(var ri=0;ri<remBtns.length;ri++){
      remBtns[ri].addEventListener('click', function(ev){
        var id=ev.currentTarget.getAttribute('data-remove-j');
        state.junctions = state.junctions.filter(function(x){return x.id!==id;});
        renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); setDefaultHorizon(); render(); updateDataValidation();
      });
    }
    // totals init
    for(var t=0;t<state.junctions.length;t++) updateTotalsForJunction(state.junctions[t].id);
  }

  function rebuildJourneyMatrix(){
    var cont=$('journeyMatrix'); if(!cont) return; cont.innerHTML='';
    var n=state.junctions.length; if(n<2){ cont.textContent='Add at least two junctions.'; return; }
    var table=document.createElement('table'); table.className='stagesTable';
    var thead=document.createElement('thead'); var hrow='<tr><th>From \\ To</th>'; 
    for(var i=0;i<n;i++) hrow+='<th>'+state.junctions[i].name+'</th>'; hrow+='</tr>'; thead.innerHTML=hrow; table.appendChild(thead);
    var tbody=document.createElement('tbody');
    for(var r=0;r<n;r++){
      var fromJ=state.junctions[r]; var row='<td><strong>'+fromJ.name+'</strong></td>';
      for(var c=0;c<n;c++){
        var toJ=state.junctions[c];
        if(fromJ.id===toJ.id){ row+='<td style="text-align:center;color:#888">—</td>'; }
        else{ var key=fromJ.id+'->'+toJ.id; var val= state.journeys[key]!=null? state.journeys[key] : 20;
          row+='<td><input data-journey="'+key+'" type="text" inputmode="numeric" pattern="[0-9]*" value="'+val+'"></td>'; }
      }
      var tr=document.createElement('tr'); tr.innerHTML=row; tbody.appendChild(tr);
    }
    table.appendChild(tbody); cont.appendChild(table);
    var inps = cont.querySelectorAll('input[data-journey]');
    for(var i=0;i<inps.length;i++){
      (function(inp){
        function commit(){ state.journeys[inp.getAttribute('data-journey')] = num(inp.value); render(); }
        inp.addEventListener('blur', commit); inp.addEventListener('change', commit);
      })(inps[i]);
    }
  }

  // Validation
  function validate(){
    var errors=[];
    if(state.junctions.length<2) errors.push('Add at least two junctions.');
    for(var i=0;i<state.junctions.length;i++){
      var j=state.junctions[i]; alignIntergreens(j);
      if(j.stages.length===0) errors.push(j.name+': add at least one stage.');
      if(j.intergreens.length!==j.stages.length) errors.push(j.name+': intergreens count must match stages count.');
      if(j.cycleTimeSec<=0) errors.push(j.name+': cycle time must be > 0.');
      var st=0, ig=0; for(var k=0;k<j.stages.length;k++){ st+=num(j.stages[k].durationSec); ig+=num(j.intergreens[k].durationSec||0); }
      if((st+ig)!==j.cycleTimeSec){ errors.push(j.name+': stages + intergreens ('+(st+ig)+'s = '+st+'s + '+ig+'s) must equal cycle ('+j.cycleTimeSec+'s).'); }
    }
    return errors;
  }
  function updateDataValidation(){
    var out=$('dataValidation'); var errs=validate();
    if(!out) return;
    if(errs.length){ out.innerHTML='<div class="bad"><strong>Fix these first:</strong><ul>'+errs.map(function(e){return '<li>'+e+'</li>';}).join('')+'</ul></div>'; }
    else out.innerHTML='<div class="good">Config looks valid ✔️</div>';
  }

  // Plot helpers
  function maxCycle(){ var m=0; for(var i=0;i<state.junctions.length;i++) m=Math.max(m, state.junctions[i].cycleTimeSec||0); return m; }
  function setDefaultHorizon(){ var def = Math.max(60, maxCycle()+20); var h=$('horizon'); if(!h) return; if(state.horizonIsDefault || !num(h.value)){ h.value=String(def); state.horizonSec=def; state.horizonIsDefault=true; } }
  function presentRowOrder(){ var out=[]; for(var i=0;i<state.rowOrder.length;i++){ if(getJ(state.rowOrder[i])) out.push(state.rowOrder[i]); } return out; }
  function stageFill(idx){ var shades=['#1b5e20','#2e7d32','#388e3c','#43a047','#4caf50','#66bb6a','#7cb342','#8bc34a']; return shades[idx%shades.length]; }
  function bandsOneCycle(j){ var out=[],t=0; for(var i=0;i<j.stages.length;i++){ var s=j.stages[i]; out.push({type:'stage',label:s.label,start:t,end:t+s.durationSec,index:i}); t+=s.durationSec; var ig=j.intergreens[i].durationSec||0; out.push({type:'intergreen',start:t,end:t+ig,index:i}); t+=ig; } return out; }
  function tileBands(j,h,start,end){ start = (typeof start==='number')? start : 0; end = (typeof end==='number')? end : h; var tiles=[],cycleStart=j.startTimeSec, C=j.cycleTimeSec; while(cycleStart>start) cycleStart-=C; while(cycleStart+C<start) cycleStart+=C; while(cycleStart<end){ var bands=bandsOneCycle(j); for(var b=0;b<bands.length;b++){ var bb=bands[b]; tiles.push({type:bb.type,label:bb.label,index:bb.index,startAbs:cycleStart+bb.start,endAbs:cycleStart+bb.end}); } cycleStart+=C; } return tiles.filter(function(b){return b.endAbs>=start && b.startAbs<=end;}); }
  function channelBox(i){ var yTop = 20 + i*(30+120); var yBandTop = yTop+10, yBandBot=yBandTop+30; var nextTop = 20 + (i+1)*(30+120); return {y0:yBandTop+30+10, y1:nextTop-10, mid: (yBandTop+30+10 + nextTop-10)/2}; }

  function ensureArrowDefs(s){ if(s.querySelector('defs#arrowDefs')) return; var defs=elNS('defs'); defs.id='arrowDefs'; var m=elNS('marker'); m.setAttribute('id','arrow'); m.setAttribute('viewBox','0 0 10 10'); m.setAttribute('refX','8'); m.setAttribute('refY','5'); m.setAttribute('markerWidth','6'); m.setAttribute('markerHeight','6'); m.setAttribute('orient','auto'); var p=elNS('path'); p.setAttribute('d','M 0 0 L 10 5 L 0 10 z'); p.setAttribute('fill','context-stroke'); m.appendChild(p); defs.appendChild(m); s.appendChild(defs); }

  function paperWidth(){ var s=$('diagram'); return (s&&s.clientWidth)?s.clientWidth:960; }

  function render(){
    var s=$('diagram'); if(!s) return; s.innerHTML='';
    var H = state.horizonSec = num($('horizon').value) || Math.max(60, maxCycle()+20);
    if(!$('horizon').value) $('horizon').value=String(H);
    var showMainGrid = state.showMainGrid = $('showMainGrid').checked;
    var width = paperWidth(); var MARGIN=60; var HEIGHT = 20 + (presentRowOrder().length-1)*(30+120) + 30 + 80; s.setAttribute('height', String(HEIGHT));
    var usableW = (width - MARGIN - 10);
    var PAD = H; // triple-buffer: draw t in [-H, H+H]
    var xScale = function(t){ return MARGIN + (t/H)*usableW; }; // visible window scaler for [0..H]
    var xScaleAbs = function(tAbs){ return MARGIN + ((tAbs + PAD)/H)*usableW; }; // absolute time scaler for [-PAD..H+PAD]

    ensureArrowDefs(s);

    // global grid
    if(showMainGrid){
      for(var t=0;t<=H;t+=10){ var ln=elNS('line'); setAttrs(ln,{x1:xScale(t),y1:8,x2:xScale(t),y2:HEIGHT-8,class:'gridLine'}); s.appendChild(ln); if(t%30===0){ var tx=elNS('text'); setAttrs(tx,{x:xScale(t)+2,y:12,class:'axisLabel'}); tx.textContent=t+'s'; s.appendChild(tx);} }
    } else {
      for(var t=0;t<=H;t+=30){ var tx2=elNS('text'); setAttrs(tx2,{x:xScale(t)+2,y:12,class:'axisLabel'}); tx2.textContent=t+'s'; s.appendChild(tx2); }
    }

    var order = presentRowOrder();
    for(var r=0;r<order.length;r++){
      var j=getJ(order[r]); var yTop=20 + r*(30+120); var yBandTop=yTop+10, yBandBot=yBandTop+30;
      var lbl=elNS('text'); setAttrs(lbl,{x:10,y:yTop+4,class:'rowLabel'}); lbl.textContent=j.name; s.appendChild(lbl);
      var offlbl=elNS('text'); setAttrs(offlbl,{x:10,y:yTop+16,class:'offsetLabel'}); offlbl.textContent='Offset: '+(j.startTimeSec||0)+'s'; s.appendChild(offlbl);

      // ticks
      for(var t=0;t<=H;t+=1){ var x=xScale(t); var l1=elNS('line'); setAttrs(l1,{x1:x,y1:yBandTop-3,x2:x,y2:yBandTop,class:'tick1'}); s.appendChild(l1); var l2=elNS('line'); setAttrs(l2,{x1:x,y1:yBandBot,x2:x,y2:yBandBot+3,class:'tick1'}); s.appendChild(l2); }
      for(var t5=0;t5<=H;t5+=5){ var x5=xScale(t5); var L1=elNS('line'); setAttrs(L1,{x1:x5,y1:yBandTop-6,x2:x5,y2:yBandTop,class:'tick5'}); s.appendChild(L1); var L2=elNS('line'); setAttrs(L2,{x1:x5,y1:yBandBot,x2:x5,y2:yBandBot+6,class:'tick5'}); s.appendChild(L2); }

      // tiles
      var tiles=tileBands(j,H,-PAD,H+PAD);
      for(var b=0;b<tiles.length;b++){
        var m=tiles[b]; var x=xScaleAbs(m.startAbs), x2=xScaleAbs(m.endAbs); var w=Math.max(0,x2-x);
        var rect=elNS('rect'); setAttrs(rect,{x:x,y:yBandTop,width:w,height:30,class:(m.type==='stage'?'stageRect':'intergreenRect')}); if(m.type==='stage') rect.setAttribute('fill', stageFill(m.index)); s.appendChild(rect);
        if(m.label && m.type==='stage' && w>24){ var t=elNS('text'); setAttrs(t,{x:x+w/2,y:yBandTop+15,class:'stageLabel'}); t.textContent=m.label; s.appendChild(t); }
      }

      // stage local labels
      var C=j.cycleTimeSec, t0=j.startTimeSec||0; var tTiles = tileBands(j,H,-PAD,H+PAD).filter(function(b){return b.type==='stage';});
      for(var b2=0;b2<tTiles.length;b2++){
        var bb=tTiles[b2]; var xs=xScaleAbs(bb.startAbs), xe=xScaleAbs(bb.endAbs);
        var startLocal=posMod(bb.startAbs - t0, C), endLocal=posMod(bb.endAbs - t0, C);
        var ty=yBandTop-8;
        var tS=elNS('text'); setAttrs(tS,{x:xs,y:ty,class:'stageTimeLabel'}); tS.textContent=startLocal+'s'; s.appendChild(tS);
        var tE=elNS('text'); setAttrs(tE,{x:xe,y:ty,class:'stageTimeLabel'}); tE.textContent=endLocal+'s'; s.appendChild(tE);
      }

      // per-row cycle markers
      if(C>0){
        var first=t0; while(first<0) first+=C; while(first-C>=0) first-=C;
        for(var tt=first; tt<=H; tt+=C){ if(tt<=0) continue; var xl=xScale(tt); var ln2=elNS('line'); setAttrs(ln2,{x1:xl,y1:yBandTop-6,x2:xl,y2:yBandBot+6,class:'gridLine'}); ln2.setAttribute('stroke','#e53935'); ln2.setAttribute('stroke-width','2'); s.appendChild(ln2); }
        var yBottomLbl=yBandBot+16; var lab=t0; while(lab<0) lab+=5; while(lab-5>=0) lab-=5;
        for(var ttt=lab; ttt<=H; ttt+=5){ var tx=elNS('text'); setAttrs(tx,{x:xScale(ttt)+2,y:yBottomLbl,class:'axisLabel'}); tx.textContent=String(posMod(ttt - t0, C))+'s'; s.appendChild(tx); }
      }
    }

    // channel grids
    if(showMainGrid){
      for(var i=0;i<order.length-1;i++){ var ch=channelBox(i); for(var t=0;t<=H;t+=10){ var ln=elNS('line'); setAttrs(ln,{x1:xScale(t),y1:ch.y0,x2:xScale(t),y2:ch.y1,class:'channelGrid'}); s.appendChild(ln);} }
    }

    // overlays
    function channelPath(a,b){ var o=presentRowOrder(); var ai=o.indexOf(a), bi=o.indexOf(b); if(ai===-1||bi===-1) return []; var path=[], step=ai<bi?1:-1; for(var i=ai;i!==bi;i+=step){ var id1=o[i], id2=o[i+step]; var top=o.indexOf(id1)<o.indexOf(id2)?id1:id2; var bottom=(top===id1)?id2:id1; path.push(top+'-'+bottom); } return path; }
    function otherEndOf(chId, cur){ var p=chId.split('-'); return cur===p[0]? p[1]:p[0]; }
    function moduloTime(t,h){ var m=t%h; return m<0? m+h:m; }
    function splitLineAtHorizon(t0,y0,t1,y1,h){
      if(t0===t1) return [{t0:t0,y0:y0,t1:t1,y1:y1}];
      if(t1>=t0) return [{t0:t0,y0:y0,t1:t1,y1:y1}];
      var alpha=(h - t0)/((t1 + h)-t0); var yAtH = y0 + (y1 - y0) * alpha;
      return [{t0:t0,y0:y0,t1:h,y1:yAtH},{t0:0,y0:yAtH,t1:t1,y1:y1}];
    }
    function phaseShiftForHorizon(j,H){ var C=j&&j.cycleTimeSec||0; if(!C||!H) return 0; return H % C; }
    function mapTimePhase(tAbs, refJunc, H){
      if(!H) return 0;
      var mode = state.wrapMode || 'phase';
      if(mode==='none'){
        // No wrap: clamp to [0,H] for visibility
        var t = Math.max(0, Math.min(H, tAbs));
        return t;
      }
      var m = tAbs % H; if(m<0) m += H; // base modulo
      if(mode==='mod') return m;
      var C = (refJunc && refJunc.cycleTimeSec) || 0;
      var phi = (C>0) ? (H % C) : 0; // phase advance across the horizon
      return (m + phi) % H;
    }

    function hopDraw(t0Abs, fromId, hopId, color, opacity, isBack, origin, dest){
      var toId = otherEndOf(hopId, fromId);
      var key = fromId+'->'+toId; if(!(key in state.journeys)) return {t1:t0Abs, pieces:[], yStart:null, yEnd:null};
      var dt = state.journeys[key];
      var orderList = presentRowOrder(); var parts=hopId.split('-'); var i = Math.min(orderList.indexOf(parts[0]), orderList.indexOf(parts[1]));
      var ch = channelBox(i); var fromAbove = orderList.indexOf(fromId) < orderList.indexOf(toId);
      var yStart = fromAbove ? ch.y0 : ch.y1; var yEnd = fromAbove ? ch.y1 : ch.y0;
      var line = elNS('line'); setAttrs(line,{x1:xScaleAbs(t0Abs), y1:yStart, x2:xScaleAbs(t0Abs+dt), y2:yEnd, class:'coordLine '+(isBack?'back':'')});
      line.style.stroke=color; line.style.opacity=opacity; line.setAttribute('marker-end','url(#arrow)'); s.appendChild(line);
      return {t1:t0Abs+dt, pieces:[{t0:t0Abs,t1:t0Abs+dt,y0:yStart,y1:yEnd}], yStart:yStart, yEnd:yEnd};
    }
    }

    function refreshLegend(){
      var el=$('legend'); if(!el) return; el.innerHTML='';
      for(var oi=0;oi<state.overlays.length;oi++){
        var ov=state.overlays[oi]; var item=document.createElement('div'); item.className='item';
        var sw=document.createElement('span'); sw.className='swatch'; sw.style.background=ov.color;
        var lbl=document.createElement('span');
        lbl.textContent = (ov.type==='custom' ? (getJ(ov.origin.junc).name+' ['+ov.origin.tStart+'–'+ov.origin.tEnd+'s'+(ov.repeatCycle?' ×':'')+'] → '+getJ(ov.dest.junc).name)
         : (getJ(ov.origin.junc).name+':'+getJ(ov.origin.junc).stages[ov.origin.stageIndex].label+(ov.repeatStage?' ×':'')+' → '+getJ(ov.dest.junc).name));
        var del=document.createElement('button'); del.className='small'; del.textContent='Remove'; del.addEventListener('click', (function(id){ return function(){ state.overlays = state.overlays.filter(function(x){return x.id!==id;}); refreshLegend(); render(); }; })(ov.id));
        item.appendChild(sw); item.appendChild(lbl); item.appendChild(del); el.appendChild(item);
      }
    }
    refreshLegend();

    // draw overlays
    for(var oi=0;oi<state.overlays.length;oi++){
      var ov=state.overlays[oi]; var origin=getJ(ov.origin.junc), dest=getJ(ov.dest.junc); if(!origin||!dest) continue;
      var path=channelPath(origin.id, dest.id); if(path.length===0) continue;

      var tiles;
      if(ov.type==='custom'){
        tiles=[];
        if(ov.repeatCycle){ var C=origin.cycleTimeSec||0; if(C>0){ var cStart=origin.startTimeSec||0; while(cStart>-PAD) cStart-=C; while(cStart+C<-PAD) cStart+=C; while(cStart<H+PAD){ tiles.push({startAbs:cStart+ov.origin.tStart,endAbs:cStart+ov.origin.tEnd}); cStart+=C; } } else { tiles=[{startAbs:ov.origin.tStart,endAbs:ov.origin.tEnd}]; } }
        else tiles=[{startAbs:ov.origin.tStart,endAbs:ov.origin.tEnd}];
      }else{
        var tb=tileBands(origin,H,-PAD,H+PAD).filter(function(b){return b.type==='stage' && b.label===origin.stages[ov.origin.stageIndex].label;});
        if(ov.repeatStage){ tiles = tb.map(function(b){return {startAbs:b.startAbs,endAbs:b.endAbs};}); }
        else { if(tb.length){ var first = tb[0]; tiles=[{startAbs:first.startAbs,endAbs:first.endAbs}]; } else { tiles=[]; } }
      }

      if(state.overrunMode==='skip'){ tiles = tiles.filter(function(b){return b.startAbs>=-PAD && b.endAbs<=H+PAD;}); }
      else tiles = tiles.filter(function(b){return b.endAbs>-PAD && b.startAbs<H+PAD;});

      for(var ti=0;ti<tiles.length;ti++){
        var seg=tiles[ti];
        var tf=seg.startAbs, tb=seg.endAbs, fromF=origin.id, fromB=origin.id;
        var quads=[];
        for(var hpi=0;hpi<path.length;hpi++){
          var hop=path[hpi];
          var resF=hopDraw(tf, fromF, hop, ov.color, ov.opacity||0.8, false, origin, dest);
          var resB=hopDraw(tb, fromB, hop, ov.color, ov.opacity||0.8, true, origin, dest);
          // Align polygon splits: if either side wraps, split the other at the same fraction along its segment
          var segsF = resF.pieces, segsB = resB.pieces;
          if(resF.wrap && !resB.wrap){
            var yH_B = resB.yStart + (resB.yEnd - resB.yStart)*resF.frac;
            segsB = [ {t0:resB.t0m, y0:resB.yStart, t1:H, y1:yH_B}, {t0:0, y0:yH_B, t1:resB.t1m, y1:resB.yEnd} ];
          } else if(!resF.wrap && resB.wrap){
            var yH_F = resF.yStart + (resF.yEnd - resF.yStart)*resB.frac;
            segsF = [ {t0:resF.t0m, y0:resF.yStart, t1:H, y1:yH_F}, {t0:0, y0:yH_F, t1:resF.t1m, y1:resF.yEnd} ];
          }
          var maxPieces = Math.max(segsF.length, segsB.length);
          for(var k=0;k<maxPieces;k++){
            var pf=segsF[k]||null, pb=segsB[k]||null;
            if(pf && pb){
              var poly=elNS('polygon');
              var pts= xScale(pf.t0)+','+pf.y0+' '+xScale(pf.t1)+','+pf.y1+' '+xScale(pb.t1)+','+pb.y1+' '+xScale(pb.t0)+','+pb.y0;
              setAttrs(poly,{points:pts}); poly.setAttribute('fill', ov.color); poly.setAttribute('opacity','0.18'); s.appendChild(poly);
            }
          }
          tf=resF.t1; tb=resB.t1; fromF=otherEndOf(hop,fromF); fromB=otherEndOf(hop,fromB);
        }

        // arrival band on destination using phase-aware times
        var destRowIdx = presentRowOrder().indexOf(dest.id);
        var yTopDest = 20 + destRowIdx*(30+120) + 10;
        var rect=elNS('rect'); setAttrs(rect,{x:xScaleAbs(tf), y:yTopDest, width:Math.max(0, xScaleAbs(tb)-xScaleAbs(tf)), height:30, class:'arrivalHighlight'});
        rect.style.fill=ov.color; rect.style.opacity=Math.max(0.05, 0.35*(ov.opacity||0.8)); s.appendChild(rect);
      }
    }

    // travel time labels
    for(var i=0;i<order.length-1;i++){
      var from=order[i], to=order[i+1], ch=channelBox(i), midY=ch.mid, leftX=48, rightX=(paperWidth())-16;
      var kf=from+'->'+to, kr=to+'->'+from;
      if(state.journeys[kf]!=null){ var t1=elNS('text'); setAttrs(t1,{x:leftX,y:midY,class:'channelTT'}); t1.textContent=from+'↓'+to+' '+state.journeys[kf]+'s'; s.appendChild(t1); }
      if(state.journeys[kr]!=null){ var t2=elNS('text'); setAttrs(t2,{x:rightX,y:midY,class:'channelTT'}); t2.setAttribute('text-anchor','end'); t2.textContent=state.journeys[kr]+'s '+to+'↑'+from; s.appendChild(t2); }
    }

    updateDataValidation();
  }

  // Overlay controls
  function refreshOverlayPickers(){
    var o=$('ovOrigin'), d=$('ovDest'), s=$('ovStage'), coO=$('coOrigin'), coD=$('coDest');
    function fillSel(sel){ if(!sel) return; sel.innerHTML=''; for(var i=0;i<state.rowOrder.length;i++){ var id=state.rowOrder[i]; var j=getJ(id); if(j){ var opt=document.createElement('option'); opt.value=id; opt.textContent=j.name; sel.appendChild(opt);} } }
    fillSel(o); fillSel(d); fillSel(coO); fillSel(coD);
    if(s){ s.innerHTML=''; var j0=getJ(presentRowOrder()[0]); if(j0){ for(var i=0;i<j0.stages.length;i++){ var op=document.createElement('option'); op.value=String(i); op.textContent=j0.stages[i].label; s.appendChild(op);} } }
  }

  function renderLegend(){ var el=$('legend'); if(!el) return; el.innerHTML=''; for(var oi=0;oi<state.overlays.length;oi++){ var ov=state.overlays[oi]; var item=document.createElement('div'); item.className='item'; var sw=document.createElement('span'); sw.className='swatch'; sw.style.background=ov.color; var lbl=document.createElement('span'); if(ov.type==='custom'){ lbl.textContent=getJ(ov.origin.junc).name+' ['+ov.origin.tStart+'–'+ov.origin.tEnd+(ov.repeatCycle?' ×':'')+'] → '+getJ(ov.dest.junc).name; } else { lbl.textContent=getJ(ov.origin.junc).name+':'+getJ(ov.origin.junc).stages[ov.origin.stageIndex].label+' → '+getJ(ov.dest.junc).name; } var del=document.createElement('button'); del.className='small'; del.textContent='Remove'; (function(id){ del.addEventListener('click', function(){ state.overlays=state.overlays.filter(function(x){return x.id!==id;}); renderLegend(); render(); }); })(ov.id); item.appendChild(sw); item.appendChild(lbl); item.appendChild(del); el.appendChild(item);} }

  // Event wiring
  document.addEventListener('DOMContentLoaded', function(){
    initTabs();
    buildDefaults();
    $('plotBtn').addEventListener('click', function(){ var out=$('dataValidation'); var errs=validate(); if(errs.length&&out){ out.innerHTML='<div class="bad"><strong>Fix these first:</strong><ul>'+errs.map(function(e){return '<li>'+e+'</li>';}).join('')+'</ul></div>'; } render(); });
    $('validateBtn').addEventListener('click', updateDataValidation);
    var h=$('horizon'); if(h){ var to=null; h.addEventListener('input', function(){ if(to) clearTimeout(to); to=setTimeout(function(){ state.horizonIsDefault=false; state.horizonSec=num(h.value)||Math.max(60,maxCycle()+20); render(); }, 120); }); h.addEventListener('blur', function(){ state.horizonIsDefault=false; state.horizonSec=num(h.value)||Math.max(60,maxCycle()+20); render(); }); h.addEventListener('change', function(){ state.horizonIsDefault=false; state.horizonSec=num(h.value)||Math.max(60,maxCycle()+20); render(); }); }
    $('showMainGrid').addEventListener('change', function(){ render(); });
    $('phaseWrapBy').addEventListener('change', function(e){ state.phaseWrapMode = e.target.value==='destination'?'destination':'origin'; render(); });
    $('wrapMode').addEventListener('change', function(e){ state.wrapMode = e.target.value; render(); });

    $('addOverlayBtn').addEventListener('click', function(){
      var origin=$('ovOrigin').value, dest=$('ovDest').value, stageIndex=Number($('ovStage').value), mode=$('ovMode').value, color=$('ovColor').value, op=Number($('ovOpacity').value||0.8);
      if(origin===dest){ $('readout').innerHTML='<div class="bad">Origin and destination must differ.</div>'; return; }
      var id='ov'+Date.now()+Math.floor(Math.random()*1000);
      state.overlays.push({ id:id, type:'stage', origin:{ junc:origin, stageIndex:stageIndex, mode:mode, repeat:true }, dest:{ junc:dest }, color:color, opacity:op, repeatStage: $('ovRepeat').checked });
      renderLegend(); render();
    });
    $('addCustomOverlayBtn').addEventListener('click', function(){
      var origin=$('coOrigin').value, dest=$('coDest').value, tStart=num($('coStart').value||0), tEnd=num($('coEnd').value||0), color=$('coColor').value||'#9c27b0', op=Number($('coOpacity').value||0.8), rep=$('coRepeat').checked;
      if(dest===origin){ $('readout').innerHTML='<div class="bad">Origin and destination must differ.</div>'; return; }
      if(tEnd<tStart){ var tmp=tStart; tStart=tEnd; tEnd=tmp; }
      var id='cov'+Date.now()+Math.floor(Math.random()*1000);
      state.overlays.push({ id:id, type:'custom', origin:{ junc:origin, tStart:tStart, tEnd:tEnd }, dest:{ junc:dest }, color:color, opacity:op, repeatCycle:rep });
      renderLegend(); render();
    });

    // Data export/import
    $('exportBtn').addEventListener('click', function(){
      var payload = JSON.stringify(state, null, 2);
      var blob = new Blob([payload], {type:'application/json'}); var url = URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='signals-config-v1.json'; a.click(); setTimeout(function(){URL.revokeObjectURL(url);},1000);
    });
    $('importInput').addEventListener('change', function(e){
      var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var obj=JSON.parse(r.result); state.junctions=obj.junctions||state.junctions; state.journeys=obj.journeys||state.journeys; state.horizonSec=obj.horizonSec||state.horizonSec; state.overlays=obj.overlays||state.overlays; state.overrunMode=obj.overrunMode||state.overrunMode; renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); setDefaultHorizon(); renderLegend(); render(); updateDataValidation(); document.querySelector('[data-tab="plotTab"]').click(); }catch(err){ var out=$('dataValidation'); if(out) out.innerHTML='<div class="bad">Import failed: '+err.message+'</div>'; } }; r.readAsText(f);
    });
    $('saveTdBtn').addEventListener('click', function(){ var payload=JSON.stringify(state,null,2); var blob=new Blob([payload],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='signal-plan-checker.td'; a.click(); setTimeout(function(){URL.revokeObjectURL(url);},1000); });
    $('loadTdInput').addEventListener('change', function(e){ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var obj=JSON.parse(r.result); state.junctions=obj.junctions||state.junctions; state.journeys=obj.journeys||state.journeys; state.horizonSec=obj.horizonSec||state.horizonSec; state.overlays=obj.overlays||state.overlays; state.overrunMode=obj.overrunMode||state.overrunMode; renderJunctionList(); rebuildJourneyMatrix(); refreshOverlayPickers(); setDefaultHorizon(); renderLegend(); render(); updateDataValidation(); document.querySelector('[data-tab="plotTab"]').click(); }catch(err){ var out=$('dataValidation'); if(out) out.innerHTML='<div class="bad">TD load failed: '+err.message+'</div>'; } }; r.readAsText(f); });

    // Reset to defaults
    $('resetDefaultsBtn').addEventListener('click', function(){ try{ state.overlays=[]; buildDefaults(); renderLegend(); render(); updateDataValidation(); document.querySelector('[data-tab="plotTab"]').click(); }catch(e){ log('Reset failed: '+e.message,'err'); } });

    // Prevent backspace from navigating
    window.addEventListener('keydown', function(e){ var t=e.target; var inEdit = t && (t.tagName==='INPUT'||t.tagName==='TEXTAREA'||t.isContentEditable); if((e.key==='Backspace'||e.key==='Delete') && !inEdit){ e.preventDefault(); } }, true);

    // First plot
    requestAnimationFrame(render);
  });

})();
  // ==== Robust boot sequence (guaranteed) ====
  function __safeInit(){
    try{
      log('Booting…', 'info');
      if(!state || !state.junctions){ log('State missing', 'err'); return; }
      if(!state.junctions.length){
        buildDefaults();
      }
      renderJunctionList();
      rebuildJourneyMatrix();
      refreshOverlayPickers();
      renderLegend();
      setDefaultHorizon();
      render();
      updateDataValidation();
      log('Ready.', 'info');
    }catch(e){
      var box=document.getElementById('debugLog');
      if(box){ var div=document.createElement('div'); div.className='err'; div.textContent='Init error: '+e.message; box.appendChild(div); }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      __safeInit();
      var f=document.getElementById('forceInitBtn');
      if(f){ f.addEventListener('click', function(){ __safeInit(); }); }
    }catch(e){
      var box=document.getElementById('debugLog');
      if(box){ var div=document.createElement('div'); div.className='err'; div.textContent='DOMContentLoaded error: '+e.message; box.appendChild(div); }
    }
  });

</script>
</body>
</html>
